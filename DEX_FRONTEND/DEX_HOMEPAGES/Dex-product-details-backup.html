<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title id="page-title">Loading... ‚Ä¢ Dex‚Ñ¢</title>
    <link rel="icon" href="../DEX_FAVICON/favicon.png" />
    <link
      href="https://fonts.googleapis.com/css2?family=Fredoka+One&family=Quicksand:wght@300;400;500;600;700&display=swap"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.6.0/css/all.min.css"
    />
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />

    <style>
      #submit-review,
      .back-btn {
        transition: var(--transition);
        cursor: pointer;
      }
      .clickable-name:hover,
      .seller-shop-link a {
        text-decoration: underline;
      }
      :root {
        --green: #008000;
        --green-light: #6ecf45;
        --pink: #ff6ac1;
        --blue: #4dabf7;
        --orange: #ff9f43;
        --gold: #ffd700;
        --radius: 20px;
        --shadow: 0 15px 40px rgba(0, 0, 0, 0.25);
        --transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.2);
      }
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }
      body {
        font-family: Quicksand, sans-serif;
        background: linear-gradient(rgba(0, 30, 0, 0.7), rgba(0, 0, 0, 0.85)),
          url("../DEX_HOMEPAGES/images/community.webp") center/cover fixed;
        color: #fff;
        min-height: 100vh;
        image-rendering: auto;
      }
      header {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        z-index: 1000;
        background: rgba(0, 128, 0, 0.95);
        backdrop-filter: blur(14px);
        padding: 1rem 2rem;
        display: flex;
        justify-content: space-between;
        align-items: center;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.4);
      }
      #company-name a {
        font-family: "Fredoka One", cursive;
        font-size: 2.4rem;
        color: #fff;
        text-decoration: none;
      }
      .back-btn {
        background: rgba(255, 255, 255, 0.15);
        color: #fff;
        border: none;
        padding: 12px 20px;
        border-radius: 50px;
        font-weight: 600;
      }
      .product-reviews h3,
      .review-author {
        color: var(--green-light);
      }
      .back-btn:hover {
        background: rgba(255, 255, 255, 0.3);
        transform: translateY(-3px);
      }
      .product-page {
        max-width: 1360px;
        margin: 120px auto 80px;
        padding: 48px 32px;
        background: rgba(255, 255, 255, 0.11);
        backdrop-filter: blur(9px);
        border-radius: 28px;
        box-shadow: 0 20px 50px rgba(0, 0, 0, 0.3),
          0 0 0 1px rgba(255, 255, 255, 0.08) inset;
        border: 1px solid rgba(255, 255, 255, 0.14);
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 60px;
        position: relative;
        overflow: hidden;
      }
      .product-page::before {
        content: "";
        position: absolute;
        inset: 0;
        background: linear-gradient(
          135deg,
          rgba(110, 207, 69, 0.08),
          transparent 50%
        );
        opacity: 0;
        transition: opacity 0.5s;
        pointer-events: none;
        border-radius: 28px;
      }
      .product-page:hover::before {
        opacity: 1;
      }
      @media (max-width: 968px) {
        .product-page {
          grid-template-columns: 1fr;
          gap: 40px;
          padding: 32px 20px;
        }
      }
      .left-column {
        display: flex;
        flex-direction: column;
        gap: 50px;
      }
      .product-gallery {
        position: relative;
        border-radius: var(--radius);
        overflow: hidden;
        background: rgba(255, 255, 255, 0.05);
        padding: 8px;
        backdrop-filter: blur(10px);
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
        transition: 0.5s;
      }
      .product-gallery:hover {
        box-shadow: 0 20px 50px rgba(0, 0, 0, 0.45);
        transform: translateY(-4px);
      }
      #main-image {
        width: 100%;
        height: 520px;
        object-fit: cover;
        border-radius: calc(var(--radius) - 4px);
        display: block;
        transition: transform 0.9s cubic-bezier(0.23, 1, 0.32, 1), filter 0.6s;
        will-change: transform;
      }
      .product-gallery:hover #main-image {
        transform: scale(1.06);
        filter: brightness(1.05) contrast(1.08);
      }
      .thumbnail-container {
        display: flex;
        gap: 14px;
        margin-top: 20px;
        padding: 12px 8px 8px;
        overflow-x: auto;
        scroll-behavior: smooth;
        scrollbar-width: thin;
        scrollbar-color: var(--green-light) transparent;
      }
      .thumbnail-container::-webkit-scrollbar {
        height: 6px;
      }
      .thumbnail-container::-webkit-scrollbar-track {
        background: rgba(255, 255, 255, 0.08);
        border-radius: 10px;
      }
      #submit-review,
      .thumbnail.active::after {
        background: var(--green-light);
        font-weight: 700;
      }
      .thumbnail-container::-webkit-scrollbar-thumb {
        background: var(--green-light);
        border-radius: 10px;
        opacity: 0.7;
      }
      .thumbnail.active,
      .thumbnail:hover {
        opacity: 1;
        border-color: var(--green-light);
      }
      .thumbnail {
        width: 96px;
        height: 96px;
        object-fit: cover;
        border-radius: 16px;
        cursor: pointer;
        border: 4px solid transparent;
        opacity: 0.65;
        flex-shrink: 0;
        transition: 0.45s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        transform: translateY(0);
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
        background: #111;
      }
      #review-form,
      .product-reviews {
        background: rgba(255, 255, 255, 0.06);
      }
      .thumbnail:hover {
        transform: translateY(-10px) scale(1.12);
        box-shadow: 0 16px 40px rgba(110, 207, 69, 0.4);
        z-index: 10;
      }
      .thumbnail.active {
        transform: translateY(-12px) scale(1.15);
        box-shadow: 0 20px 50px rgba(110, 207, 69, 0.5),
          0 0 0 4px rgba(110, 207, 69, 0.3);
        position: relative;
      }
      .thumbnail.active::after {
        content: "‚úì";
        position: absolute;
        top: 8px;
        right: 8px;
        color: #000;
        width: 24px;
        height: 24px;
        border-radius: 50%;
        font-size: 14px;
        display: flex;
        align-items: center;
        justify-content: center;
        box-shadow: 0 4px 10px rgba(0, 0, 0, 0.4);
      }
      .thumbnail:focus-visible {
        outline: 0;
        border-color: var(--green-light);
        box-shadow: 0 0 0 4px rgba(110, 207, 69, 0.4);
      }
      .product-reviews {
        border-radius: 20px;
        padding: 32px;
        border: 1px solid rgba(255, 255, 255, 0.1);
        animation: 0.9s ease-out forwards slideUp;
      }
      @keyframes slideUp {
        from {
          opacity: 0;
          transform: translateY(40px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }
      .product-reviews h3 {
        font-size: 1.9rem;
        margin-bottom: 24px;
        text-align: center;
      }
      .review {
        background: rgba(255, 255, 255, 0.08);
        margin-bottom: 16px;
        border-left: 4px solid var(--green-light);
        opacity: 0;
        transform: translateY(20px);
        animation: 0.7s ease-out forwards fadeInUp;
        transition: transform 0.3s, box-shadow 0.3s;
      }
      .review:hover {
        transform: translateY(-6px) scale(1.02);
        box-shadow: 0 12px 30px rgba(0, 0, 0, 0.3);
      }
      .review:first-child {
        animation-delay: 0.1s;
      }
      .review:nth-child(2) {
        animation-delay: 0.2s;
      }
      .review:nth-child(3) {
        animation-delay: 0.3s;
      }
      .review:nth-child(4) {
        animation-delay: 0.4s;
      }
      @keyframes fadeInUp {
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }
      .review-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 10px;
      }
      .review-rating {
        color: var(--gold);
        font-size: 1.4rem;
      }
      .review-text {
        margin-top: 8px;
        line-height: 1.6;
      }
      .review-status {
        font-size: 0.8rem;
        padding: 4px 10px;
        border-radius: 20px;
        font-weight: 700;
      }
      .status-pending {
        background: #f39c12;
        color: #000;
      }
      .approve-btn,
      .status-approved {
        background: #27ae60;
        color: #fff;
      }
      .reject-btn,
      .status-rejected {
        background: #e74c3c;
        color: #fff;
      }
      .status-rejected {
        opacity: 0.7;
      }
      .moderation-actions {
        display: flex;
        gap: 8px;
        margin-top: 12px;
      }
      .moderation-actions button {
        padding: 6px 12px;
        border: none;
        border-radius: 8px;
        font-size: 0.8rem;
        font-weight: 700;
        cursor: pointer;
        transition: 0.2s;
      }
      .delete-btn {
        background: #c0392b;
        color: #fff;
      }
      .price,
      .seller-shop-link a,
      .seller-shop-link i {
        color: var(--green-light);
      }
      .moderation-actions button:hover {
        transform: scale(1.08);
      }
      #review-form {
        margin-top: 40px;
        padding: 24px;
        border-radius: 16px;
      }
      #review-text,
      .product-details {
        background: rgba(255, 255, 255, 0.1);
      }
      #review-text {
        width: 100%;
        padding: 16px;
        border-radius: 12px;
        border: none;
        color: #fff;
        font-size: 1rem;
        resize: vertical;
        min-height: 120px;
        margin-bottom: 16px;
      }
      #submit-review {
        color: #000;
        padding: 14px 32px;
        border-radius: 50px;
      }
      #submit-review:hover {
        transform: translateY(-4px);
        box-shadow: 0 10px 25px rgba(110, 207, 69, 0.5);
      }
      .product-details {
        backdrop-filter: blur(20px);
        border-radius: var(--radius);
        padding: 40px;
        box-shadow: var(--shadow);
        border: 1px solid rgba(255, 255, 255, 0.15);
        animation: 0.9s ease-out slideInRight;
      }
      @keyframes slideInRight {
        from {
          opacity: 0;
          transform: translateX(50px);
        }
        to {
          opacity: 1;
          transform: translateX(0);
        }
      }
      #product-name {
        font-size: 2.6rem;
        font-weight: 700;
        margin-bottom: 12px;
        background: linear-gradient(90deg, #fff, var(--green-light));
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
      }
      .category-tag {
        display: inline-block;
        padding: 8px 20px;
        border-radius: 30px;
        font-weight: 600;
        font-size: 0.95rem;
        margin-bottom: 16px;
      }
      .price {
        font-size: 3rem;
        font-weight: 800;
        margin: 16px 0;
      }
      #product-description {
        font-size: 1.1rem;
        line-height: 1.8;
        color: #ddd;
        margin: 20px 0 30px;
      }
      .seller-info {
        display: flex;
        align-items: center;
        gap: 16px;
        padding: 16px;
        background: rgba(255, 255, 255, 0.08);
        border-radius: 16px;
        margin: 20px 0;
        transition: 0.4s;
      }
      .seller-info:hover {
        background: rgba(255, 255, 255, 0.15);
        transform: translateY(-4px);
        box-shadow: 0 15px 35px rgba(0, 0, 0, 0.3);
        border-radius: 20px;
      }
      .clickable-avatar,
      .clickable-name {
        cursor: pointer;
        transition: 0.3s;
      }
      .clickable-avatar:hover {
        transform: scale(1.1);
        box-shadow: 0 0 0 4px rgba(110, 207, 69, 0.3);
        border-radius: 50%;
      }
      .clickable-name:hover {
        color: var(--green-light) !important;
      }
      .seller-text {
        flex: 1;
        display: flex;
        flex-direction: column;
        gap: 6px;
      }
      .seller-shop-link {
        display: flex;
        align-items: center;
        font-size: 0.95rem;
      }
      .seller-shop-link i {
        margin-right: 6px;
      }
      .seller-shop-link a:hover {
        color: #fff;
      }
      .seller-avatar {
        width: 70px;
        height: 70px;
        border-radius: 50%;
        object-fit: cover;
        border: 4px solid #fff;
        box-shadow: 0 6px 20px rgba(0, 0, 0, 0.4);
      }
      .product-actions {
        display: flex;
        gap: 16px;
        margin: 30px 0;
      }
      .btn {
        padding: 18px 40px;
        border: none;
        border-radius: 50px;
        font-size: 1.2rem;
        font-weight: 700;
        cursor: pointer;
        transition: var(--transition);
        flex: 1;
      }
      .btn-primary {
        background: linear-gradient(135deg, #25d366, #128c7e);
        color: #fff;
        box-shadow: 0 10px 30px rgba(37, 211, 102, 0.4);
      }
      .btn-primary:hover {
        transform: translateY(-6px) scale(1.03);
        box-shadow: 0 16px 40px rgba(37, 211, 102, 0.6);
      }
      #add-to-wishlist {
        background: rgba(255, 255, 255, 0.15);
        color: #fff;
      }
      #add-to-wishlist.active {
        color: #f33;
        background: rgba(255, 51, 51, 0.2);
        animation: 1.5s ease-in-out pulse;
      }
      #add-to-wishlist i {
        font-size: 1.6rem;
        margin-right: 8px;
        transition: 0.3s;
      }
      #add-to-wishlist.active i {
        animation: 1.2s infinite heartbeat;
      }
      @keyframes heartbeat {
        0%,
        100% {
          transform: scale(1);
        }
        50% {
          transform: scale(1.4);
        }
      }
      .specs-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 20px;
        margin: 30px 0;
        padding: 24px;
        background: rgba(255, 255, 255, 0.08);
        border-radius: 18px;
        border: 1px solid rgba(255, 255, 255, 0.1);
      }
      .spec-item {
        display: flex;
        flex-direction: column;
        gap: 8px;
      }
      .review,
      .reviews-list {
        gap: 1rem;
        display: flex;
      }
      .spec-label {
        font-size: 0.9rem;
        color: #aaa;
        font-weight: 500;
      }
      .spec-value {
        font-size: 1.1rem;
        font-weight: 600;
        color: #fff;
      }
      .loading {
        text-align: center;
        padding: 100px 20px;
        font-size: 1.4rem;
        color: #aaa;
      }
      .reviews-list {
        flex-direction: column;
        margin-top: 1rem;
      }
      .review {
        align-items: flex-start;
        padding: 12px 16px;
        border-radius: 12px;
        background-color: #f5f5f5;
        box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
      }
      .review .review-avatar {
        width: 50px;
        height: 50px;
        border-radius: 50%;
        cursor: pointer;
        object-fit: cover;
        border: 2px solid var(--green-light);
      }
      .review-content {
        flex: 1;
      }
      .review-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
      }
      .review-author {
        font-weight: 700;
        cursor: pointer;
        color: var(--blue);
      }
      .review-date {
        font-size: 0.8rem;
        color: #777;
      }
      .review-rating {
        color: var(--gold);
        margin: 4px 0;
      }
      .review-text {
        font-size: 0.95rem;
        color: #333;
      }
      @keyframes pulse {
        0%,
        100% {
          transform: scale(1);
        }
        50% {
          transform: scale(1.1);
        }
      }
      @media (max-width: 1200px) {
        .product-page {
          max-width: 1000px;
          padding: 40px 28px;
        }
      }
      @media (max-width: 968px) {
        .product-page {
          grid-template-columns: 1fr;
          gap: 40px;
          padding: 32px 20px;
          margin: 100px auto 60px;
        }
        #main-image {
          height: 420px !important;
        }
      }
      @media (max-width: 768px) {
        body {
          background: linear-gradient(135deg, #004d26, #001a0f, #000);
        }
        header {
          padding: 0.8rem 1.5rem;
        }
        #company-name a {
          font-size: 2rem;
        }
        .back-btn {
          padding: 10px 16px;
          font-size: 0.95rem;
        }
        .category-tag {
          font-size: 0.9rem;
          padding: 6px 16px;
        }
        .product-page {
          padding: 20px 14px;
          margin: 80px auto 40px;
          border-radius: 20px;
        }
        #main-image {
          object-fit: contain;
          background: rgba(0, 0, 0, 0.3);
          height: auto !important;
          max-height: 70vh;
          width: 100%;
          object-fit: contain;
        }
        .product-actions {
          flex-direction: column;
          gap: 12px;
        }
        .btn {
          padding: 16px 20px;
          font-size: 1.1rem;
        }
        #product-name {
          font-size: 1.9rem;
          line-height: 1.2;
        }
        .price {
          font-size: 2.3rem;
        }
        #product-description {
          font-size: 1rem;
        }
        #review-text {
          min-height: 100px;
          font-size: 0.95rem;
        }
        #submit-review {
          width: 100%;
          padding: 14px;
        }
        .seller-avatar,
        .thumbnail {
          width: 80px;
          height: 80px;
        }
        .thumbnail-container {
          gap: 10px;
          padding: 10px 4px;
        }
        .seller-info {
          flex-direction: column;
          text-align: center;
          gap: 12px;
        }
        .product-gallery:hover,
        .product-gallery:hover #main-image,
        .review:hover,
        .seller-info:hover {
          transform: none;
        }
        #add-to-wishlist span,
        .product-page::before {
          display: none;
        }
        .specs-grid {
          grid-template-columns: 1fr;
          gap: 16px;
          padding: 20px;
        }
        #add-to-wishlist i {
          margin: 0;
        }
      }
    </style>
  </head>
  <body>
    <header>
      <h1 id="company-name"><a href="Dex-shop.html">Dex‚Ñ¢</a></h1>
      <button class="back-btn" onclick="history.back()">‚Üê Back to Shop</button>
    </header>

    <main class="product-page" id="product-container">
      <div class="loading">
        <i
          class="fas fa-spinner fa-spin"
          style="font-size: 3rem; margin-bottom: 20px"
        ></i>
        <p>Loading premium product...</p>
        <div id="reviews-list" class="reviews-list">
          <!-- Reviews will be dynamically injected here -->
        </div>
      </div>
    </main>

    <script>
      const productId = new URLSearchParams(location.search).get("id");
      const container = document.getElementById("product-container");
      const baseUrl = "http://localhost:5000";

      // ================== TOKEN ==================
      const getToken = () => {
        try {
          const stored =
            localStorage.getItem("currentUser") ||
            sessionStorage.getItem("currentUser");
          if (!stored) return "";
          const user = JSON.parse(stored);
          return user?.token || "";
        } catch (e) {
          console.warn("Corrupted user data", e);
          return "";
        }
      };
      const token = getToken();

      // ================== PRODUCT DETAILS RENDER ==================
      function renderDetails(details) {
        if (!details || typeof details !== "object") return "";
        let html = '<div class="specs-grid">';
        Object.entries(details).forEach(([key, value]) => {
          if (!value) return;
          const label =
            key.charAt(0).toUpperCase() +
            key.slice(1).replace(/([A-Z])/g, " $1");
          const emoji = key.toLowerCase().includes("storage")
            ? "üíæ"
            : key.toLowerCase().includes("ram")
            ? "üß†"
            : key.toLowerCase().includes("battery")
            ? "üîã"
            : key.toLowerCase().includes("processor")
            ? "‚öôÔ∏è"
            : key.toLowerCase().includes("camera")
            ? "üì∏"
            : key.toLowerCase().includes("screen")
            ? "üñ•Ô∏è"
            : key.toLowerCase().includes("condition")
            ? "‚ú®"
            : key.toLowerCase().includes("color")
            ? "üé®"
            : "üìå";

          if (key.toLowerCase() === "color") {
            html += `<div class="spec-item"><span class="spec-label">${label} ${emoji}</span>
        <div style="display:flex;align-items:center;gap:10px;">
          <span style="width:32px;height:32px;border-radius:50%;background:${value};border:3px solid #fff;box-shadow:0 4px 12px rgba(0,0,0,0.4);"></span>
          <span class="spec-value">${value.toUpperCase()}</span>
        </div></div>`;
          } else if (key.toLowerCase() === "condition") {
            const bg = value === "Brand New" ? "#6ecf45" : "#f1c40f";
            html += `<div class="spec-item"><span class="spec-label">Condition ${emoji}</span>
        <span class="spec-value" style="background:${bg};color:#000;padding:8px 18px;border-radius:50px;font-weight:bold;">
          ${value} ${value === "Brand New" ? "üÜï" : "‚ôªÔ∏è"}
        </span></div>`;
          } else {
            html += `<div class="spec-item"><span class="spec-label">${label} ${emoji}</span>
        <span class="spec-value">${value}</span></div>`;
          }
        });
        html += "</div>";
        return html;
      }

      // ================== LOAD PRODUCT ==================
      async function loadProduct() {
        if (!token) {
          container.innerHTML = `<div class="loading"><p>Please <a href="REGISTRY_PAGES/Sign_in.html">sign in</a> to view products</p></div>`;
          return;
        }

        try {
          const res = await fetch(`${baseUrl}/api/products/${productId}`, {
            headers: { Authorization: `Bearer ${token}` },
          });
          if (!res.ok) throw new Error("Not found");
          const p = await res.json();

          const currentUserStr =
            localStorage.getItem("currentUser") ||
            sessionStorage.getItem("currentUser");
          const currentUser = currentUserStr ? JSON.parse(currentUserStr) : {};
          const isBuyer = currentUser.role === "buyer";
          const isThisSeller =
            currentUser.role === "seller" &&
            p.seller &&
            (String(p.seller._id) === String(currentUser.id) ||
              String(p.seller._id) === String(currentUser.sellerId) ||
              String(p.seller.userId) === String(currentUser.id));

          document.title = `${p.name} ‚Ä¢ Dex‚Ñ¢`;

          const cat = (p.category || "").toLowerCase();
          const catEmoji = cat.includes("fashion")
            ? "üëó"
            : cat.includes("electro")
            ? "üì±"
            : cat.includes("hostel")
            ? "üõèÔ∏è"
            : "üì¶";

          const sellerName = p.seller?.name || "Seller";
          const sellerId = p.seller?._id || p.seller?.id;
          const sellerPic = p.seller?.profilePic
            ? `${baseUrl}${p.seller.profilePic}`
            : `https://ui-avatars.com/api/?name=${encodeURIComponent(
                sellerName
              )}&background=333&color=fff&bold=true`;

          const phone = p.seller?.phone?.replace(/\D/g, "") || "";
          const whatsappUrl = phone
            ? `https://wa.me/${phone}?text=${encodeURIComponent(
                `Hi ${sellerName}! I'm interested in "${p.name}" on Dex‚Ñ¢`
              )}`
            : "";

          let productCount = "?";
          try {
            const countRes = await fetch(
              `${baseUrl}/api/products?sellerId=${sellerId}`,
              {
                headers: { Authorization: `Bearer ${token}` },
              }
            );
            if (countRes.ok) {
              const data = await countRes.json();
              productCount = (Array.isArray(data) ? data : data.products || [])
                .length;
            }
          } catch (e) {}

          const shopLink = isThisSeller
            ? "PROFILE_PAGES/Sellers_page.html"
            : `sellerShop.html?sellerId=${sellerId}`;
          const shopText = isThisSeller
            ? `My Dashboard (${productCount} items)`
            : `View Shop (${productCount} items)`;

          container.innerHTML = `
  <div class="left-column">
    <div class="product-gallery">
      <img id="main-image" src="${baseUrl}${p.images[0]}" alt="${
            p.name
          }" loading="eager" fetchpriority="high">
      <div class="thumbnail-container">
        ${p.images
          .map(
            (img, i) => `
          <img src="${baseUrl}${img}" alt="Thumb ${i + 1}" class="thumbnail ${
              i === 0 ? "active" : ""
            }"
               onclick="document.getElementById('main-image').src=this.src;
                        document.querySelectorAll('.thumbnail').forEach(t=>t.classList.remove('active'));
                        this.classList.add('active')">
        `
          )
          .join("")}
      </div>
    </div>

    <section class="product-reviews">
      <h3>${isThisSeller ? "Your Product Reviews" : "Customer Reviews"}</h3>
      <div id="reviews-list"></div>
      ${
        isBuyer
          ? `
        <div id="review-form">
          <textarea id="review-text" placeholder="Share your experience..."></textarea>
          <div style="display:flex;gap:12px;align-items:center;margin:12px 0;">
            <span style="color:#aaa;font-size:0.9rem;">Rate it:</span>
            <div id="star-rating" style="font-size:2.2rem;cursor:pointer;">
              ${[1, 2, 3, 4, 5]
                .map((i) => `<span class="star" data-value="${i}">‚òÜ</span>`)
                .join("")}
            </div>
          </div>
          <button id="submit-review">Submit Review</button>
        </div>
      `
          : ""
      }
    </section>
  </div>

  <div class="product-details">
    <h1 id="product-name">${p.name}</h1>
    <span class="category-tag" style="background:rgba(255,255,255,0.15);color:var(--green-light);border:2px solid var(--green-light)">
      ${p.category || "Uncategorized"} ${catEmoji}
    </span>
    <div class="price">‚Çµ${Number(p.price).toLocaleString()}</div>

    <div class="seller-info">
      <img src="${sellerPic}" alt="${sellerName}" class="seller-avatar clickable-avatar"
           onclick="window.location.href='sellerProfile.html?id=${sellerId}'">
      <div class="seller-text">
        <strong class="clickable-name" onclick="window.location.href='sellerProfile.html?id=${sellerId}'">
          ${sellerName} ${isThisSeller ? "(You)" : ""}
        </strong>
        <div class="seller-shop-link">
          <a href="${shopLink}" style="color:var(--green-light);font-weight:600;">
            ${shopText}
          </a>
        </div>
        <small>${
          phone ? `WhatsApp: ${p.seller.phone}` : "Contact available"
        }</small>
      </div>
    </div>

    <p id="product-description">${
      p.description || "No description available."
    }</p>
    ${p.details ? renderDetails(p.details) : ""}

    <div class="product-actions">
      ${
        whatsappUrl
          ? `<button class="btn btn-primary" onclick="window.open('${whatsappUrl}', '_blank')">
             Chat on WhatsApp
           </button>`
          : `<button class="btn" style="opacity:0.6;cursor:not-allowed;">
             WhatsApp Unavailable
           </button>`
      }

      ${
        p.seller?.email
          ? `<button class="btn btn-primary" onclick="window.location.href='mailto:${
              p.seller.email
            }?subject=Inquiry about ${encodeURIComponent(p.name)} on Dex‚Ñ¢'">
             Email Seller
           </button>`
          : `<button class="btn" style="opacity:0.6;cursor:not-allowed;">
             Email Unavailable
           </button>`
      }

      ${
        isBuyer
          ? `<button id="add-to-wishlist" class="btn">
             <span>Add to Wishlist</span>
           </button>`
          : `<button class="btn" style="opacity:0.6;cursor:not-allowed;">
             Wishlist (Buyers only)
           </button>`
      }
    </div>
  </div>
`;

          // ================== WISHLIST ==================
          if (isBuyer) {
            const wishlistBtn = document.getElementById("add-to-wishlist");
            if (wishlistBtn) {
              const buyerId = currentUser.id;

              async function checkWishlistStatus() {
                try {
                  const res = await fetch(`${baseUrl}/api/wishlist`, {
                    headers: { Authorization: `Bearer ${token}` },
                  });
                  if (!res.ok) return;
                  const wishlist = await res.json();
                  const isWishlisted = wishlist.some(
                    (item) => item.product?.id === Number(productId)
                  );
                  wishlistBtn.classList.toggle("active", isWishlisted);
                  wishlistBtn.innerHTML = isWishlisted
                    ? '<i class="fas fa-heart"></i> Wishlisted ‚ù§Ô∏è'
                    : '<i class="fas fa-heart"></i> Add to Wishlist';
                } catch (err) {
                  console.error(err);
                }
              }

              wishlistBtn.addEventListener("click", async () => {
                if (wishlistBtn.disabled) return;
                const isActive = wishlistBtn.classList.contains("active");
                try {
                  const res = await fetch(
                    `${baseUrl}/api/wishlist${isActive ? `/${productId}` : ""}`,
                    {
                      method: isActive ? "DELETE" : "POST",
                      headers: {
                        "Content-Type": "application/json",
                        Authorization: `Bearer ${token}`,
                      },
                      body: isActive
                        ? null
                        : JSON.stringify({ productId: Number(productId) }),
                    }
                  );
                  const data = await res.json();
                  if (res.ok || data.message?.includes("Already")) {
                    wishlistBtn.classList.toggle("active");
                    wishlistBtn.innerHTML = wishlistBtn.classList.contains(
                      "active"
                    )
                      ? '<i class="fas fa-heart"></i> Wishlisted ‚ù§Ô∏è'
                      : '<i class="fas fa-heart"></i> Add to Wishlist';
                    alert(
                      wishlistBtn.classList.contains("active")
                        ? "Added to wishlist ‚ù§Ô∏è"
                        : "Removed from wishlist"
                    );
                  } else {
                    alert(data.message || "Operation failed");
                  }
                } catch (err) {
                  alert("Network error. Try again later.");
                }
              });

              checkWishlistStatus();
            }
          }

          // ================== REVIEWS ==================
          if (isBuyer) {
            let selectedRating = 5;
            const stars = document.querySelectorAll("#star-rating .star");
            const updateStars = () => {
              stars.forEach((s, i) => {
                s.textContent = i < selectedRating ? "‚òÖ" : "‚òÜ";
                s.style.color = i < selectedRating ? "var(--gold)" : "#666";
              });
            };
            stars.forEach((star, i) => {
              star.addEventListener("mouseover", () => {
                stars.forEach((s, j) => {
                  s.textContent = j <= i ? "‚òÖ" : "‚òÜ";
                  s.style.color = j <= i ? "var(--gold)" : "#666";
                });
              });
              star.addEventListener("click", () => {
                selectedRating = i + 1;
                updateStars();
              });
            });
            document
              .getElementById("star-rating")
              .addEventListener("mouseleave", updateStars);
            updateStars();

            document
              .getElementById("submit-review")
              .addEventListener("click", async () => {
                const text = document
                  .getElementById("review-text")
                  .value.trim();
                if (!text || text.length < 10)
                  return alert("Review too short! üìù");
                try {
                  const res = await fetch(`${baseUrl}/api/reviews`, {
                    method: "POST",
                    headers: {
                      "Content-Type": "application/json",
                      Authorization: `Bearer ${token}`,
                    },
                    body: JSON.stringify({
                      productId: Number(productId),
                      comment: text,
                      rating: selectedRating,
                    }),
                  });
                  if (res.ok) {
                    alert("Thank you! Review submitted ‚≠ê");
                    document.getElementById("review-text").value = "";
                    loadReviews();
                  } else {
                    const data = await res.json();
                    alert(data.message || "Failed to submit");
                  }
                } catch (err) {
                  alert("Network error üåê");
                }
              });
          }

          // ================== LOAD REVIEWS ==================
          async function loadReviews() {
            const reviewsList = document.getElementById("reviews-list");
            if (!reviewsList) return;
            try {
              const res = await fetch(
                `${baseUrl}/api/reviews/product/${productId}`,
                { headers: { Authorization: `Bearer ${token}` } }
              );
              if (!res.ok) throw new Error();
              const reviews = await res.json();
              if (!reviews || reviews.length === 0) {
                reviewsList.innerHTML =
                  '<p style="text-align:center;color:#aaa;padding:3rem;">No reviews yet. Be the first!</p>';
                return;
              }
              reviewsList.innerHTML = reviews
                .sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt))
                .map((r) => {
                  const buyer = r.buyer || { name: "Anonymous" };
                  const avatar = buyer.profilePic
                    ? `${baseUrl}${buyer.profilePic}`
                    : `https://ui-avatars.com/api/?name=${encodeURIComponent(
                        buyer.name
                      )}&background=333&color=fff&bold=true`;
                  return `<div class="review">
              <img src="${avatar}" alt="${buyer.name}" class="review-avatar">
              <div class="review-content">
                <div class="review-header">
                  <div class="review-author">${buyer.name}</div>
                  <div class="review-date">${new Date(
                    r.createdAt
                  ).toLocaleDateString()}</div>
                </div>
                <div class="review-rating">${"‚òÖ".repeat(r.rating)}${"‚òÜ".repeat(
                    5 - r.rating
                  )}</div>
                <div class="review-text">${r.comment || "No comment"}</div>
              </div>
            </div>`;
                })
                .join("");
            } catch (err) {
              reviewsList.innerHTML =
                '<p style="text-align:center;color:#aaa;">Failed to load reviews</p>';
            }
          }

          loadReviews();
        } catch (err) {
          container.innerHTML = `<div class="loading"><p>Product not found ‚ùå</p></div>`;
        }
      }

      loadProduct();
    </script>
  </body>
</html>
