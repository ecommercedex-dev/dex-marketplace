<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Dex‚Ñ¢ - üîê Reset Password</title>

    <link
      rel="icon"
      type="image/x-icon"
      href="../../../DEX_FAVICON/favicon.png"
    />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />
    <link
      href="https://fonts.googleapis.com/css2?family=Quicksand:wght@400;500;700&family=Fredoka+One&display=swap"
      rel="stylesheet"
    />

    <style>
      * {
        box-sizing: border-box;
      }

      body {
        font-family: "Quicksand", sans-serif;
        margin: 0;
        padding: 0;
        background: linear-gradient(rgba(5, 5, 5, 0.9), rgba(0, 0, 0, 0.95)),
          url("Images/pexels-cottonbro-7407369.jpg") center/cover no-repeat;
        overflow: hidden;
        color: #fff;
        position: relative;
      }

      #particles-js {
        position: absolute;
        width: 100%;
        height: 100%;
        z-index: 0;
      }

      header {
        background: rgba(0, 0, 0, 0.7);
        color: #fff;
        padding: 15px 30px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        backdrop-filter: blur(6px);
        animation: fadeInDown 0.8s ease;
        position: relative;
        z-index: 2;
      }

      header h1 a {
        color: #f4c542;
        text-decoration: none;
        font-family: "Fredoka One", cursive;
        font-size: 1.8rem;
      }

      nav ul {
        list-style: none;
        display: flex;
        gap: 20px;
        margin: 0;
        padding: 0;
      }

      nav a {
        color: #fff;
        text-decoration: none;
        font-weight: 500;
        transition: color 0.3s;
      }

      nav a:hover {
        color: #f4c542;
      }

      main {
        position: relative;
        z-index: 2;
        min-height: 80vh;
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 40px;
      }

      form {
        background: rgba(0, 0, 0, 0.7);
        padding: 30px;
        border-radius: 14px;
        width: 100%;
        max-width: 360px;
        text-align: center;
        color: #fff;
        box-shadow: 0 8px 24px rgba(0, 0, 0, 0.6);
        animation: fadeUp 0.8s ease;
      }

      h2 {
        color: #f4c542;
        margin-bottom: 10px;
        font-weight: 700;
      }

      p {
        font-size: 13px;
        margin-bottom: 20px;
        color: #ccc;
      }

      .input-group {
        position: relative;
        margin-bottom: 20px;
      }

      .input-group i {
        position: absolute;
        top: 50%;
        transform: translateY(-50%);
        color: #aaa;
        font-size: 14px;
      }

      .input-group i.fa-lock,
      .input-group i.fa-key {
        left: 12px;
      }

      .toggle-password {
        right: 12px;
        cursor: pointer;
      }

      .input-group input {
        width: 100%;
        padding: 10px 36px;
        border: 1px solid #444;
        border-radius: 8px;
        outline: none;
        font-size: 14px;
        background: rgba(255, 255, 255, 0.08);
        color: #fff;
        transition: border 0.3s, background 0.3s;
      }

      .input-group input:focus {
        border-color: #f4c542;
        background: rgba(255, 255, 255, 0.12);
      }

      button {
        width: 100%;
        padding: 11px;
        background: #f4c542;
        color: #000;
        border: none;
        border-radius: 8px;
        font-size: 15px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s;
        box-shadow: 0 0 12px rgba(244, 197, 66, 0.3);
      }

      button:hover {
        background: #e0b42f;
        box-shadow: 0 0 18px rgba(244, 197, 66, 0.4);
      }

      footer {
        position: relative;
        z-index: 2;
        background: rgba(0, 0, 0, 0.7);
        color: #fff;
        text-align: center;
        padding: 15px;
        font-size: 13px;
        backdrop-filter: blur(4px);
      }

      footer a {
        color: #f4c542;
        text-decoration: none;
      }

      /* === Toast Notifications === */
      .toast {
        position: fixed;
        top: 25px;
        right: 25px;
        background: rgba(20, 20, 20, 0.95);
        border-left: 5px solid #f4c542;
        padding: 14px 18px;
        color: #fff;
        border-radius: 8px;
        font-size: 14px;
        opacity: 0;
        transform: translateY(-20px);
        animation: fadeInToast 0.5s forwards;
        box-shadow: 0 0 10px rgba(244, 197, 66, 0.4);
        z-index: 99;
      }

      @keyframes fadeInToast {
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      @keyframes fadeUp {
        from {
          opacity: 0;
          transform: translateY(20px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      @keyframes fadeInDown {
        from {
          opacity: 0;
          transform: translateY(-20px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }
    </style>
  </head>

  <body>
    <div id="particles-js"></div>

    <header>
      <h1><a href="../../DEX_FRONTEND/Dex-home.html">Dex‚Ñ¢</a></h1>
      <nav>
        <ul>
          <li><a href="../../DEX_FRONTEND/Dex-home.html">üè† Home</a></li>
          <li><a href="../../DEX_CONTACT/Dex-contact.html">üìû Contact</a></li>
        </ul>
      </nav>
    </header>

    <main>
      <form id="resetForm">
        <h2>üîë Reset Password</h2>
        <p>‚úâÔ∏è Enter the code sent to your email and create a new password üîê</p>

        <div class="input-group">
          <i class="fa fa-key"></i>
          <input
            type="text"
            name="code"
            required
            placeholder="üß© Enter Reset Code"
          />
        </div>

        <div class="input-group">
          <i class="fa fa-lock"></i>
          <input
            type="password"
            name="newPassword"
            required
            placeholder="üîí New Password"
            id="newPassword"
          />
          <i class="fa fa-eye toggle-password" id="togglePassword"></i>
        </div>

        <button type="submit">üöÄ Reset Password</button>

        <p style="margin-top: 15px; font-size: 12px">
          ü§î Remembered your password?
          <a
            href="../REGISTORY_PAGES/seller_sign_in.html"
            style="color: #f4c542"
          >
            Back to Seller Login üîô
          </a>
        </p>
      </form>
    </main>

    <footer>
      <p>&copy; 2025 Dex‚Ñ¢. All rights reserved.</p>
      <p>
        <a href="../../../DEX_LEGALPAGES/privacy.html">üìú Privacy Policy</a> |
        <a href="../../../DEX_LEGALPAGES/terms.html">‚öñÔ∏è Terms of Service</a>
      </p>
    </footer>

    <script src="https://cdn.jsdelivr.net/npm/particles.js"></script>
    <script>
      particlesJS("particles-js", {
        particles: {
          number: { value: 70 },
          color: { value: "#f4c542" },
          shape: { type: "circle" },
          opacity: { value: 0.3 },
          size: { value: 2 },
          line_linked: { enable: false },
          move: { speed: 0.6, direction: "none", out_mode: "out" },
        },
        interactivity: { detect_on: "canvas" },
        retina_detect: true,
      });

      document.addEventListener("DOMContentLoaded", () => {
        const form = document.querySelector("form");
        const togglePassword = document.getElementById("togglePassword");
        const passwordField = document.getElementById("newPassword");

        // ========== Password visibility toggle ==========
        togglePassword.addEventListener("click", () => {
          const isPassword = passwordField.type === "password";
          passwordField.type = isPassword ? "text" : "password";
          togglePassword.classList.toggle("fa-eye");
          togglePassword.classList.toggle("fa-eye-slash");
        });

        // ========== Extract URL parameters ==========
        const params = new URLSearchParams(window.location.search);
        const role = params.get("role") === "seller" ? "seller" : "buyer"; // default buyer
        const contact = params.get("contact") || params.get("email") || "";
        const codeFromURL = params.get("code") || "";

        // Pre-fill code field if code is in URL
        if (codeFromURL) {
          form.querySelector('input[name="code"]').value = codeFromURL;
        }

        // ========== API endpoints ==========
        const endpoints = {
          buyer: "http://localhost:5000/api/buyers/reset-password",
          seller: "http://localhost:5000/api/Sellers/verify-reset-code",
        };

        // ========== Redirect destinations ==========
        const redirects = {
          buyer: "../Sign_in.html",
          seller: "../seller_sign_in.html",
        };

        // ========== Toast helper ==========
        function showToast(message, type = "info") {
          const toast = document.createElement("div");
          toast.className = `toast ${type}`;
          toast.textContent = message;
          document.body.appendChild(toast);

          setTimeout(() => toast.classList.add("show"), 100);
          setTimeout(() => {
            toast.classList.remove("show");
            setTimeout(() => toast.remove(), 300);
          }, 3000);
        }

        // ========== Submit form handler ==========
        form.addEventListener("submit", async (e) => {
          e.preventDefault();

          const code = form.querySelector('input[name="code"]').value.trim();
          const newPassword = passwordField.value.trim();

          if (!contact || !code || !newPassword) {
            showToast("‚ö†Ô∏è Email/code/new password are required!", "error");
            return;
          }

          try {
            // ‚úÖ Payload for both buyers & sellers
            const bodyPayload =
              role === "buyer"
                ? { code, newPassword, contact, role } // <- use contact
                : { code, newPassword, email: contact, role }; // sellers can stay as email

            const response = await fetch(endpoints[role], {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify(bodyPayload),
            });

            const data = await response.json();

            if (!response.ok) {
              showToast(
                `‚ùå ${data.message || "Error resetting password!"}`,
                "error"
              );
              return;
            }

            showToast("‚úÖ Password reset successful! Redirecting...", "info");
            setTimeout(() => {
              window.location.href = redirects[role];
            }, 2000);
          } catch (err) {
            console.error("üí• Error:", err);
            showToast("üí• Server error! Please try again later.", "error");
          }
        });
      });
    </script>
  </body>
</html>
