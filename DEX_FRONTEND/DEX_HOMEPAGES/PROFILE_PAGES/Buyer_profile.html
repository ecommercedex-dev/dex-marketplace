<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Dex‚Ñ¢ ‚Äî My Account</title>
    <meta
      name="description"
      content="Your Dex home: profile, orders, wishlist & notifications."
    />
    <!-- Fonts & Icons -->
    <link
      href="https://fonts.googleapis.com/css2?family=Fredoka+One&family=Quicksand:wght@300;400;500;700&display=swap"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"
    />
    <link rel="icon" type="image/x-icon" href="../../DEX_FAVICON/favicon.png" />
    <link rel="stylesheet" href="assets/css/buyer-orders.css" />
    <style>
      .mobile-menu a,
      .sidebar a {
        text-decoration: none;
        gap: 14px;
      }
      :root {
        --green: #2b7a0b;
        --green-light: #6ecf45;
        --radius: 16px;
        --shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
        --transition: 0.35s ease;
        --error: #e74c3c;
        --success: #27ae60;
      }
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }
      body {
        font-family: Quicksand, sans-serif;
        background: linear-gradient(rgba(50, 50, 0, 0.55), rgba(0, 0, 0, 0.75)),
          url("../images/pexels-aysegul-aytoren-46790226-16057604.webp")
            center/cover fixed;
        min-height: 100vh;
        color: #fff;
        overflow-x: hidden;
      }
      nav {
        position: sticky;
        top: 0;
        z-index: 1000;
        padding: 1rem 2rem;
        background: linear-gradient(
          90deg,
          rgba(43, 122, 11, 0.4),
          rgba(43, 122, 11, 0.1)
        );
        backdrop-filter: blur(12px);
        display: flex;
        justify-content: space-between;
        align-items: center;
      }
      #company-name a {
        font-family: "Fredoka One", cursive;
        font-size: 2.3rem;
        color: #fff;
        text-decoration: none;
      }
      .nav-icons {
        display: flex;
        gap: 18px;
        align-items: center;
      }
      .profile-avatar {
        width: 46px;
        height: 46px;
        border-radius: 50%;
        object-fit: cover;
        border: 3px solid #fff;
        cursor: pointer;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.4);
        transition: var(--transition);
      }
      #notificationSidebar,
      .mobile-menu {
        position: fixed;
        height: 100%;
        background: rgba(15, 15, 20, 0.98);
        backdrop-filter: blur(20px);
        transition: right 0.45s cubic-bezier(0.2, 0.8, 0.2, 1);
      }
      .profile-avatar:hover {
        transform: scale(1.12);
      }
      #notificationBtn {
        position: relative;
        cursor: pointer;
        padding: 8px;
      }
      #notificationBtn i {
        font-size: 1.7rem;
        transition: 0.3s;
      }
      #notificationBtn:hover i {
        transform: scale(1.3) rotate(20deg);
      }
      #notificationBadge {
        position: absolute;
        top: -6px;
        right: -6px;
        background: var(--error);
        color: #fff;
        font-size: 0.7rem;
        font-weight: 700;
        min-width: 20px;
        height: 20px;
        border-radius: 50%;
        display: grid;
        place-items: center;
        animation: 2s infinite pulse;
      }
      @keyframes pulse {
        0%,
        100% {
          transform: scale(1);
        }
        50% {
          transform: scale(1.15);
        }
      }
      .hamburger {
        display: none;
        font-size: 1.8rem;
        cursor: pointer;
      }
      .mobile-menu {
        top: 0;
        right: -100%;
        width: 78%;
        max-width: 320px;
        padding: 6rem 1.5rem 2rem;
        z-index: 999;
        box-shadow: -10px 0 30px rgba(0, 0, 0, 0.5);
      }
      #notificationSidebar.open,
      .mobile-menu.open,
      .modal {
        right: 0;
      }
      .mobile-menu a {
        display: flex;
        align-items: center;
        color: #fff;
        font-size: 1.15rem;
        padding: 14px 16px;
        border-radius: 12px;
        margin-bottom: 8px;
        transition: var(--transition);
      }
      .mobile-menu a:hover {
        background: var(--green-light);
        color: #000;
        transform: translateX(8px);
      }
      .overlay {
        position: fixed;
        inset: 0;
        background: rgba(0, 0, 0, 0.7);
        backdrop-filter: blur(6px);
        opacity: 0;
        visibility: hidden;
        transition: 0.4s;
        z-index: 998;
      }
      .modal,
      .toast {
        z-index: 10000;
      }
      .overlay.active {
        opacity: 1;
        visibility: visible;
      }
      #notificationSidebar {
        top: 0;
        right: -440px;
        width: 440px;
        max-width: 92vw;
        height: 100dvh;
        background: linear-gradient(
          135deg,
          rgba(18, 18, 25, 0.98),
          rgba(10, 10, 18, 0.95)
        );
        backdrop-filter: blur(28px);
        -webkit-backdrop-filter: blur(28px);
        padding: 28px;
        z-index: 9999;
        overflow-y: auto;
        transition: right 0.58s cubic-bezier(0.22, 1, 0.36, 1);
        border-left: 1px solid rgba(255, 255, 255, 0.1);
        box-shadow: -20px 0 60px rgba(0, 0, 0, 0.6);
      }
      #notificationSidebar.open {
        animation: premiumSlideIn 0.6s cubic-bezier(0.22, 1, 0.36, 1) forwards;
      }
      @keyframes premiumSlideIn {
        from {
          transform: translateX(120px);
          opacity: 0;
        }
        to {
          transform: translateX(0);
          opacity: 1;
        }
      }
      .notif-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 2rem;
        padding-bottom: 1.4rem;
        border-bottom: 1px solid rgba(255, 255, 255, 0.14);
        animation: fadeInDown 0.7s ease-out;
      }
      .notif-header h3 {
        color: var(--green-light);
        font-size: 1.62rem;
        font-weight: 700;
        letter-spacing: -0.5px;
        background: linear-gradient(90deg, var(--green-light), #fff);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
      }
      #clearAllBtn {
        background: rgba(255, 255, 255, 0.14);
        border: none;
        color: #ddd;
        cursor: pointer;
        font-size: 0.94rem;
        font-weight: 600;
        padding: 9px 18px;
        border-radius: 12px;
        transition: 0.35s;
        backdrop-filter: blur(10px);
      }
      #clearAllBtn:hover {
        background: rgba(255, 255, 255, 0.26);
        color: #fff;
        transform: translateY(-3px);
        box-shadow: 0 6px 16px rgba(0, 0, 0, 0.3);
      }
      @keyframes fadeInDown {
        from {
          opacity: 0;
          transform: translateY(-10px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }
      .notif-item {
        position: relative;
        background: rgba(255, 255, 255, 0.095);
        backdrop-filter: blur(14px);
        -webkit-backdrop-filter: blur(14px);
        border-radius: 18px;
        padding: 20px;
        margin-bottom: 18px;
        border: 1px solid rgba(255, 255, 255, 0.12);
        cursor: pointer;
        transition: 0.4s cubic-bezier(0.2, 0.8, 0.2, 1);
        box-shadow: 0 6px 18px rgba(0, 0, 0, 0.22);
        opacity: 0;
        transform: translateY(25px);
      }
      .notif-item.visible {
        opacity: 1;
        transform: translateY(0);
        animation: cardPopIn 0.58s cubic-bezier(0.16, 1, 0.3, 1) forwards;
      }
      @keyframes cardPopIn {
        0% {
          transform: scale(0.9) translateY(30px);
          opacity: 0;
        }
        100% {
          transform: scale(1) translateY(0);
          opacity: 1;
        }
      }
      .card,
      .welcome-banner {
        border-radius: var(--radius);
        box-shadow: var(--shadow);
      }
      .btn,
      .sidebar a {
        transition: var(--transition);
      }
      .notif-item:hover {
        background: rgba(255, 255, 255, 0.17);
        transform: translateY(-8px) scale(1.015);
        box-shadow: 0 16px 40px rgba(0, 0, 0, 0.4),
          0 0 0 1px rgba(110, 207, 69, 0.25) inset;
      }
      .notif-item.unread {
        background: linear-gradient(
          135deg,
          rgba(110, 207, 69, 0.2),
          rgba(110, 207, 69, 0.09)
        );
        border-left: 5px solid var(--green-light);
      }
      .notif-item.unread::after {
        content: "";
        position: absolute;
        top: 20px;
        right: 20px;
        width: 12px;
        height: 12px;
        background: var(--green-light);
        border-radius: 50%;
        box-shadow: 0 0 18px rgba(110, 207, 69, 0.8);
        animation: unreadGlow 2s ease-in-out infinite;
      }
      @keyframes unreadGlow {
        0%,
        100% {
          transform: scale(1);
          opacity: 1;
        }
        50% {
          transform: scale(1.35);
          opacity: 0.65;
        }
      }
      .notif-inner {
        display: flex;
        gap: 16px;
        align-items: flex-start;
      }
      .notif-icon {
        width: 50px;
        height: 50px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.5rem;
        flex-shrink: 0;
        background: rgba(255, 255, 255, 0.14);
        backdrop-filter: blur(10px);
        box-shadow: 0 3px 10px rgba(0, 0, 0, 0.25);
        font-family: "Segoe UI Emoji", "Apple Color Emoji", "Noto Color Emoji",
          sans-serif;
      }
      .notif-icon.order {
        background: linear-gradient(135deg, #ff6b6b, #ee5a52);
      }
      .notif-icon.message {
        background: linear-gradient(135deg, #4ecdc4, #44a08d);
      }
      .notif-icon.review {
        background: linear-gradient(135deg, #feca57, #ff9ff3);
      }
      .notif-icon.system {
        background: linear-gradient(135deg, #a55eea, #6c5ce7);
      }
      .notif-icon.error {
        background: linear-gradient(135deg, #e74c3c, #c0392b);
      }
      .notif-content {
        flex: 1;
        min-width: 0;
      }
      .notif-content h4 {
        margin: 0 0 7px;
        font-size: 1.12rem;
        font-weight: 600;
        color: #fff;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
      }
      .notif-content p {
        margin: 0 0 9px;
        font-size: 0.94rem;
        color: rgba(255, 255, 255, 0.88);
        line-height: 1.48;
        display: -webkit-box;
        -webkit-line-clamp: 2;
        -webkit-box-orient: vertical;
        overflow: hidden;
      }
      .notif-time {
        font-size: 0.8rem;
        color: #bbb;
        font-weight: 500;
        opacity: 0.9;
      }
      #emptyState {
        text-align: center;
        padding: 4.5rem 1.5rem;
        color: #999;
        animation: fadeIn 0.9s ease-out;
      }
      #emptyState i {
        font-size: 3.6rem;
        opacity: 0.35;
        margin-bottom: 1.2rem;
        display: block;
        animation: float 3.5s ease-in-out infinite;
      }
      #emptyState p {
        font-size: 1.15rem;
        margin: 10px 0;
      }
      @keyframes float {
        0%,
        100% {
          transform: translateY(0);
        }
        50% {
          transform: translateY(-12px);
        }
      }
      @keyframes fadeIn {
        from {
          opacity: 0;
        }
        to {
          opacity: 1;
        }
      }
      .container {
        display: flex;
        min-height: calc(100vh - 80px);
      }
      .sidebar {
        width: 240px;
        background: rgba(0, 0, 0, 0.4);
        backdrop-filter: blur(10px);
        padding: 2rem 1rem;
      }
      .sidebar a {
        color: #fff;
        padding: 14px 18px;
        border-radius: 12px;
        display: flex;
        align-items: center;
        font-weight: 500;
      }
      .sidebar a.active,
      .sidebar a:hover {
        background: var(--green-light);
        color: #000;
        font-weight: 700;
      }
      .main-content {
        flex: 1;
        padding: 2rem;
        display: flex;
        flex-direction: column;
        gap: 2rem;
      }
      .welcome-banner {
        background: linear-gradient(135deg, var(--green-light), var(--green));
        padding: 1.8rem;
        text-align: center;
        font-weight: 600;
      }
      .card {
        background: rgba(255, 255, 255, 0.15);
        backdrop-filter: blur(12px);
        padding: 2rem;
      }
      .section {
        display: none;
        animation: 0.6s ease-out fadeIn;
      }
      .section.active {
        display: block;
      }
      @keyframes fadeIn {
        from {
          opacity: 0;
          transform: translateY(20px);
        }
        to {
          opacity: 1;
          transform: none;
        }
      }
      .form-group,
      .search-bar {
        margin-bottom: 1.5rem;
      }
      .form-group label {
        display: block;
        margin-bottom: 0.5rem;
        font-weight: 500;
        color: #ddd;
      }
      .form-group input,
      .form-group select {
        width: 100%;
        padding: 14px 16px;
        border: none;
        border-radius: 12px;
        background: rgba(255, 255, 255, 0.15);
        color: #fff;
        font-size: 1rem;
        backdrop-filter: blur(10px);
        transition: 0.3s;
      }
      .form-group input:focus,
      .form-group select:focus {
        outline: 0;
        background: rgba(255, 255, 255, 0.25);
        box-shadow: 0 0 0 3px rgba(110, 207, 69, 0.4);
      }
      .form-actions {
        display: flex;
        gap: 1rem;
        margin-top: 2rem;
      }
      .btn {
        padding: 12px 28px;
        border: none;
        border-radius: 50px;
        font-weight: 700;
        cursor: pointer;
      }
      .btn-cancel,
      .btn-track {
        color: #fff;
        padding: 6px 12px;
        border-radius: 8px;
        font-size: 0.85rem;
      }
      .btn-primary {
        background: linear-gradient(135deg, var(--green), var(--green-light));
        color: #fff;
      }
      .btn-primary:hover {
        transform: translateY(-3px);
        box-shadow: 0 8px 20px rgba(110, 207, 69, 0.4);
      }
      .btn-secondary {
        background: rgba(255, 255, 255, 0.15);
        color: #fff;
        backdrop-filter: blur(10px);
      }
      .btn-secondary:hover {
        background: rgba(255, 255, 255, 0.25);
      }
      .btn-cancel {
        background: var(--error);
      }
      .btn-cancel:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(231, 76, 60, 0.5);
      }
      .btn-track {
        background: #3498db;
      }
      .btn-track:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(52, 152, 219, 0.5);
      }
      .order-card,
      .product-card {
        transition: 0.35s cubic-bezier(0.2, 0.8, 0.2, 1) !important;
        background: rgba(255, 255, 255, 0.08) !important;
        border-radius: 16px !important;
        overflow: hidden !important;
        box-shadow: 0 8px 25px rgba(0, 0, 0, 0.2) !important;
        border: 1px solid rgba(255, 255, 255, 0.1);
      }
      .order-card:hover,
      .product-card:hover {
        transform: translateY(-4px);
      }
      #bookingsGrid,
      #followedGrid,
      .order {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
        gap: 24px;
      }

      @media (max-width: 768px) {
        #bookingsGrid,
        #followedGrid,
        .order {
          grid-template-columns: repeat(auto-fill, minmax(240px, 1fr));
          gap: 16px;
        }
      }

      @media (max-width: 480px) {
        #bookingsGrid,
        #followedGrid,
        .order {
          grid-template-columns: 1fr;
          gap: 12px;
        }
      }
      .order-card img,
      .product-card img {
        width: 100%;
        height: 180px;
        object-fit: cover;
        border-radius: var(--radius);
        transition: transform 0.6s;
      }
      .details,
      .order-details {
        display: flex;
        flex-direction: column;
        gap: 0.3rem;
      }
      .details strong,
      .order-details strong {
        color: var(--green-light);
      }
      .order-status {
        align-self: flex-start;
        padding: 4px 10px;
        border-radius: 12px;
        font-size: 0.85rem;
        font-weight: 600;
        color: #fff;
      }
      .status-pending {
        background: orange;
      }
      .status-accepted {
        background: #3498db;
      }
      .status-delivered {
        background: #2ecc71;
      }
      .status-rejected {
        background: var(--error);
      }
      .actions,
      .order-actions {
        display: flex;
        gap: 0.5rem;
        margin-top: 0.5rem;
      }
      .modal {
        position: fixed;
        top: 0;
        left: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.6);
        display: flex;
        justify-content: center;
        align-items: center;
      }
      .modal.open {
        display: flex;
      }
      .modal-content {
        background: #111;
        padding: 1.5rem;
        border-radius: 12px;
        color: #fff;
        position: relative;
        min-width: 300px;
      }
      .modal-content .close {
        position: absolute;
        top: 10px;
        right: 12px;
        cursor: pointer;
        font-size: 1.5rem;
      }
      .whatsapp-float button {
        position: fixed;
        bottom: 24px;
        right: 24px;
        z-index: 9999;
        background: #25d366;
        color: #fff;
        width: 62px;
        height: 62px;
        border-radius: 50%;
        border: none;
        font-size: 2.2rem;
        box-shadow: 0 8px 25px rgba(37, 211, 102, 0.4);
        animation: 3s ease-in-out infinite float;
        cursor: pointer;
      }
      @keyframes float {
        0%,
        100% {
          transform: translateY(0);
        }
        50% {
          transform: translateY(-8px);
        }
      }
      .toast {
        position: fixed;
        bottom: 20px;
        left: 50%;
        transform: translateX(-50%);
        background: rgba(0, 0, 0, 0.9);
        color: #fff;
        padding: 12px 24px;
        border-radius: 50px;
        font-size: 0.95rem;
        opacity: 0;
        transition: opacity 0.3s, transform 0.3s;
        box-shadow: var(--shadow);
      }
      .toast.show {
        opacity: 1;
        transform: translateX(-50%) translateY(-10px);
      }
      .toast.success {
        border-left: 4px solid var(--success);
      }
      .toast.error {
        border-left: 4px solid var(--error);
      }
      .loading {
        display: inline-block;
        width: 20px;
        height: 20px;
        border: 2px solid #fff;
        border-top-color: transparent;
        border-radius: 50%;
        animation: 0.8s linear infinite spin;
        margin-left: 8px;
      }
      @keyframes spin {
        to {
          transform: rotate(360deg);
        }
      }

      /* Order Tab Icons with Badges */
      .order-tab-icon {
        position: relative;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        transition: 0.3s;
      }

      .order-tab-icon:hover {
        transform: scale(1.1);
      }

      .order-badge {
        position: absolute;
        top: -8px;
        right: -8px;
        background: var(--green-light);
        color: #000;
        font-size: 0.75rem;
        font-weight: 700;
        min-width: 20px;
        height: 20px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
        animation: pulse 2s infinite;
      }
      .search-bar input {
        width: 100%;
        padding: 12px 16px;
        border-radius: 12px;
        border: none;
        background: rgba(255, 255, 255, 0.15);
        color: #fff;
      }
      .search-bar input::placeholder {
        color: #aaa;
      }
      @media (max-width: 768px) {
        .container {
          flex-direction: column;
        }
        .sidebar {
          display: none;
        }
        .hamburger {
          display: block;
        }
        #notificationSidebar {
          width: 80%;
          right: -100%;
        }
      }
    </style>
  </head>
  <body>
    <!-- Navbar -->
    <nav>
      <div id="company-name"><a href="../../Dex-home.html">Dex‚Ñ¢</a></div>
      <div class="nav-icons">
        <img
          id="headerAvatar"
          class="profile-avatar"
          src="../PROFILE_PAGES/default_account_picture/account.png"
          alt="Avatar"
          onclick="switchSection('profile')"
        />
        <div id="notificationBtn">
          <i class="fa-solid fa-bell"></i><span id="notificationBadge">0</span>
        </div>
        <i
          class="fa-solid fa-right-from-bracket"
          id="logoutBtn"
          title="Logout"
        ></i>
        <div class="hamburger" id="hamburger"><i class="fas fa-bars"></i></div>
      </div>
    </nav>

    <!-- Mobile Menu & Overlay -->
    <div class="mobile-menu" id="mobileMenu">
      <a href="#" data-section="profile"><i class="fas fa-user"></i> Profile</a>
      <a href="#" data-section="orders"
        ><i class="fas fa-shopping-bag"></i> My Orders</a
      >
      <a href="#" data-section="wishlist"
        ><i class="fas fa-heart"></i> Wishlist</a
      >
      <a href="#" data-section="recent"
        ><i class="fas fa-clock"></i> Recently Viewed</a
      >
      <a href="#" data-section="bookings"
        ><i class="fas fa-bed"></i> My Bookings</a
      >
      <a href="#" data-section="followed"
        ><i class="fas fa-store"></i> Followed Shops</a
      >
      <a href="#" data-section="settings"
        ><i class="fas fa-cog"></i> Settings</a
      >
      <a href="#" data-section="help"
        ><i class="fas fa-question-circle"></i> Help</a
      >
      <hr
        style="
          border: none;
          border-top: 1px solid rgba(255, 255, 255, 0.2);
          margin: 1.5rem 0;
        "
      />
      <a href="../../Dex-home.html"><i class="fas fa-home"></i> Home</a>
      <a href="../Dex-shop.html"><i class="fa-solid fa-shop"></i> Shop</a>
    </div>
    <div class="overlay" id="overlay"></div>

    <!-- Notification Sidebar -->
    <div id="notificationSidebar">
      <div class="notif-header">
        <h3>Notifications</h3>
        <button id="clearAllBtn">Clear All</button>
      </div>
      <div id="notificationList"></div>
      <div
        id="emptyState"
        style="text-align: center; padding: 3rem; color: #aaa; display: none"
      >
        <i
          class="fas fa-bell-slash"
          style="font-size: 2.5rem; opacity: 0.4"
        ></i>
        <p>No new notifications</p>
      </div>
    </div>

    <!-- Toast -->
    <div id="toast" class="toast"></div>

    <!-- Main Layout -->
    <div class="container">
      <div class="sidebar">
        <a href="#" class="active" data-section="profile"
          ><i class="fas fa-user"></i> Profile</a
        >
        <a href="#" data-section="orders"
          ><i class="fas fa-shopping-bag"></i> My Orders</a
        >
        <a href="#" data-section="wishlist"
          ><i class="fas fa-heart"></i> Wishlist</a
        >
        <a href="#" data-section="recent"
          ><i class="fas fa-clock"></i> Recently Viewed</a
        >
        <a href="#" data-section="bookings"
          ><i class="fas fa-bed"></i> My Bookings</a
        >
        <a href="#" data-section="followed"
          ><i class="fas fa-store"></i> Followed Shops</a
        >
        <a href="#" data-section="settings"
          ><i class="fas fa-cog"></i> Settings</a
        >
        <a href="#" data-section="help"
          ><i class="fas fa-question-circle"></i> Help</a
        >
        <hr
          style="
            margin: 1.5rem 0;
            border-top: 1px solid rgba(255, 255, 255, 0.2);
          "
        />
        <a href="../../Dex-home.html"><i class="fas fa-home"></i> Home</a>
        <a href="../Dex-shop.html"><i class="fa-solid fa-shop"></i> Shop</a>
      </div>

      <div class="main-content">
        <div class="welcome-banner">
          <h2>Welcome back, <span id="buyerName">Friend</span>! ‚ù§Ô∏è</h2>
          <p>Early Access ‚Äî You‚Äôre one of our first buyers. Thank you!</p>
        </div>

        <!-- PROFILE -->
        <div id="profile" class="section active card">
          <div
            style="
              display: flex;
              gap: 2rem;
              align-items: flex-start;
              flex-wrap: wrap;
            "
          >
            <div style="position: relative">
              <!-- PROFILE PICTURE - OPTIMIZED -->
              <img
                id="profilePic"
                src="../PROFILE_PAGES/default_account_picture/account.png"
                alt="Profile"
                width="130"
                height="130"
                loading="lazy"
                decoding="async"
                onerror="this.src='../PROFILE_PAGES/default_account_picture/account.png'"
              />
              <label
                style="
                  position: absolute;
                  bottom: 8px;
                  right: 8px;
                  background: var(--green);
                  width: 44px;
                  height: 44px;
                  border-radius: 50%;
                  display: grid;
                  place-items: center;
                  cursor: pointer;
                "
              >
                <i class="fa-solid fa-camera" style="color: white"></i>
                <input
                  type="file"
                  id="picInput"
                  accept="image/*"
                  style="display: none"
                />
              </label>
            </div>
            <div style="flex: 1; min-width: 220px">
              <h2 id="fullName">Loading...</h2>
              <p>
                <strong>Username:</strong> <span id="userName">Loading...</span>
              </p>
              <p>
                <strong>Index Number:</strong>
                <span id="indexNum">Loading...</span>
              </p>
              <p><strong>Role:</strong> <span id="userRole">Buyer</span></p>
              <p><strong>Email:</strong> <span id="email">Loading...</span></p>
              <p><strong>Phone:</strong> <span id="phone">Loading...</span></p>
              <p>
                <strong>Address:</strong> <span id="address">Loading...</span>
              </p>
              <button
                id="editProfileBtn"
                class="btn btn-primary"
                style="margin-top: 12px"
              >
                Edit Profile
              </button>
            </div>
          </div>
        </div>

        <!-- EDIT PROFILE -->
        <div id="editProfile" class="section card">
          <h2 style="margin-bottom: 1.5rem; color: var(--green-light)">
            Edit Profile
          </h2>
          <div
            style="
              display: flex;
              gap: 2rem;
              align-items: center;
              flex-wrap: wrap;
              margin-bottom: 2rem;
            "
          >
            <div style="position: relative">
              <img
                id="editProfilePicPreview"
                src="../PROFILE_PAGES/default_account_picture/account.png"
                alt="Preview"
                style="
                  width: 130px;
                  height: 130px;
                  border-radius: 50%;
                  border: 5px solid white;
                  box-shadow: var(--shadow);
                "
              />
              <label
                style="
                  position: absolute;
                  bottom: 8px;
                  right: 8px;
                  background: var(--green);
                  width: 44px;
                  height: 44px;
                  border-radius: 50%;
                  display: grid;
                  place-items: center;
                  cursor: pointer;
                "
              >
                <i class="fa-solid fa-camera" style="color: white"></i>
                <input
                  type="file"
                  id="editPicInput"
                  accept="image/*"
                  style="display: none"
                />
              </label>
            </div>
          </div>
          <div class="form-group">
            <label>Full Name</label
            ><input
              type="text"
              id="editName"
              placeholder="Enter your full name"
            />
          </div>
          <div class="form-group">
            <label>Email Address</label
            ><input type="email" id="editEmail" placeholder="your@email.com" />
          </div>
          <div class="form-group">
            <label>Phone Number</label
            ><input type="tel" id="editPhone" placeholder="+233 ..." />
          </div>
          <div class="form-group">
            <label>Delivery Address</label
            ><input
              type="text"
              id="editAddress"
              placeholder="e.g. Accra, Osu"
            />
          </div>
          <div class="form-actions">
            <button id="saveProfileBtn" class="btn btn-primary">
              Save Changes
              <span
                id="saveLoading"
                class="loading"
                style="display: none"
              ></span>
            </button>
            <button id="cancelEditBtn" class="btn btn-secondary">Cancel</button>
          </div>
        </div>

        <!-- ORDERS -->
        <div id="orders" class="section card">
          <div
            style="
              display: flex;
              justify-content: space-between;
              align-items: center;
              margin-bottom: 1rem;
            "
          >
            <h2 style="margin: 0">My Orders</h2>
            <div style="display: flex; gap: 1rem">
              <div
                class="order-tab-icon"
                id="buyerActiveTab"
                title="Active Orders"
                style="cursor: pointer"
              >
                <i
                  class="fas fa-shopping-bag"
                  style="font-size: 1.5rem; color: #3498db"
                ></i>
              </div>
              <div
                class="order-tab-icon"
                id="buyerDeliveredTab"
                title="Delivered Orders"
                style="cursor: pointer"
              >
                <i
                  class="fas fa-truck"
                  style="font-size: 1.5rem; color: #27ae60"
                ></i>
                <span
                  id="buyerDeliveredBadge"
                  class="order-badge"
                  style="display: none"
                  >0</span
                >
              </div>
              <div
                class="order-tab-icon"
                id="buyerRejectedTab"
                title="Rejected Orders"
                style="cursor: pointer"
              >
                <i
                  class="fas fa-trash-alt"
                  style="font-size: 1.5rem; color: #e74c3c"
                ></i>
                <span
                  id="buyerRejectedBadge"
                  class="order-badge"
                  style="display: none"
                  >0</span
                >
              </div>
            </div>
          </div>
          <div class="search-bar" style="margin-top: 20px">
            <input
              type="text"
              id="orderSearch"
              placeholder="Search orders..."
            />
          </div>
          <div
            class="order-view active"
            id="activeOrdersGrid"
            style="margin-top: 20px"
          >
            <p style="grid-column: 1/-1; text-align: center; color: #aaa">
              Loading orders...
            </p>
          </div>
          <div style="display: none" id="deliveredSection">
            <div
              style="
                display: flex;
                justify-content: space-between;
                align-items: center;
                margin: 20px 0 10px;
              "
            >
              <h3 style="margin: 0; color: #27ae60">Delivered Orders</h3>
              <button
                id="clearDeliveredBtn"
                class="btn btn-secondary"
                style="padding: 8px 16px; font-size: 0.9rem"
              >
                Clear All
              </button>
            </div>
            <div class="order-view" id="deliveredOrdersGrid"></div>
          </div>
          <div style="display: none" id="cancelledSection">
            <div
              style="
                display: flex;
                justify-content: space-between;
                align-items: center;
                margin: 20px 0 10px;
              "
            >
              <h3 style="margin: 0; color: #e74c3c">
                Rejected/Cancelled Orders
              </h3>
              <button
                id="clearCancelledBtn"
                class="btn btn-secondary"
                style="padding: 8px 16px; font-size: 0.9rem"
              >
                Clear All
              </button>
            </div>
            <div class="order-view" id="cancelledOrdersGrid"></div>
          </div>
        </div>

        <!-- WISHLIST -->
        <div id="wishlist" class="section card">
          <div
            style="
              display: flex;
              justify-content: space-between;
              align-items: center;
              margin-bottom: 1rem;
              flex-wrap: wrap;
              gap: 1rem;
            "
          >
            <h2 style="margin: 0">
              Wishlist
              <span
                id="wishlistCount"
                style="
                  font-size: 0.9rem;
                  color: #aaa;
                  font-weight: 400;
                  margin-left: 0.5rem;
                "
                >(0)</span
              >
            </h2>
            <div
              style="
                display: flex;
                gap: 1rem;
                align-items: center;
                flex-wrap: wrap;
              "
            >
              <select
                id="wishlistSort"
                style="
                  padding: 8px 12px;
                  border-radius: 8px;
                  background: rgba(255, 255, 255, 0.1);
                  color: #fff;
                  border: 1px solid rgba(255, 255, 255, 0.2);
                  cursor: pointer;
                "
              >
                <option value="recent">Recently Added</option>
                <option value="price-low">Price: Low to High</option>
                <option value="price-high">Price: High to Low</option>
                <option value="name">Name: A-Z</option>
              </select>
              <select
                id="wishlistFilter"
                style="
                  padding: 8px 12px;
                  border-radius: 8px;
                  background: rgba(255, 255, 255, 0.1);
                  color: #fff;
                  border: 1px solid rgba(255, 255, 255, 0.2);
                  cursor: pointer;
                "
              >
                <option value="all">All Items</option>
                <optgroup label="Electronics">
                  <option value="phones">Phones</option>
                  <option value="laptops">Laptops</option>
                  <option value="headsets">Headsets</option>
                  <option value="chargers">Chargers</option>
                  <option value="speakers">Speakers</option>
                </optgroup>
                <optgroup label="Fashion">
                  <option value="shoes">Shoes</option>
                  <option value="shirts">Shirts</option>
                  <option value="trousers">Trousers</option>
                  <option value="dresses">Dresses</option>
                  <option value="bags">Bags</option>
                </optgroup>
              </select>
              <button
                id="clearFilterBtn"
                class="btn btn-secondary"
                style="padding: 6px 12px; font-size: 0.85rem"
              >
                Clear Filter
              </button>
              <button
                id="clearWishlistBtn"
                class="btn btn-secondary"
                style="padding: 8px 16px; font-size: 0.9rem"
              >
                Clear All
              </button>
            </div>
          </div>
          <div
            id="wishlistGrid"
            style="
              display: grid;
              grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
              gap: 1.5rem;
            "
          >
            <p style="grid-column: 1/-1; text-align: center; color: #aaa">
              Loading wishlist...
            </p>
          </div>
        </div>

        <!-- RECENTLY VIEWED -->
        <div id="recent" class="section card">
          <div
            style="
              display: flex;
              justify-content: space-between;
              align-items: center;
              margin-bottom: 1.5rem;
            "
          >
            <h2 style="margin: 0">
              Recently Viewed
              <span
                style="
                  font-size: 0.9rem;
                  color: #aaa;
                  font-weight: 400;
                  margin-left: 0.5rem;
                "
                >(Last 20)</span
              >
            </h2>
            <button
              id="clearRecentBtn"
              class="btn btn-secondary"
              style="padding: 8px 16px; font-size: 0.9rem"
            >
              Clear All
            </button>
          </div>
          <div
            id="recentGrid"
            style="
              overflow-x: auto;
              overflow-y: hidden;
              display: flex;
              gap: 1rem;
              padding: 1rem 0;
              scroll-behavior: smooth;
              -webkit-overflow-scrolling: touch;
            "
          >
            <p
              style="
                text-align: center;
                color: #aaa;
                width: 100%;
                padding: 3rem 0;
              "
            >
              Loading...
            </p>
          </div>
        </div>

        <!-- HOSTEL BOOKINGS -->
        <div id="bookings" class="section card">
          <h2>My Hostel Bookings</h2>
          <div class="grid" id="bookingsGrid">
            <p style="grid-column: 1/-1; text-align: center; color: #aaa">
              Loading...
            </p>
          </div>
        </div>

        <!-- FOLLOWED SHOPS -->
        <div id="followed" class="section card">
          <div
            style="
              display: flex;
              justify-content: space-between;
              align-items: center;
              margin-bottom: 1rem;
              flex-wrap: wrap;
              gap: 1rem;
            "
          >
            <h2 style="margin: 0">
              Followed Shops
              <span
                id="followedCount"
                style="
                  font-size: 0.9rem;
                  color: #aaa;
                  font-weight: 400;
                  margin-left: 0.5rem;
                "
                >(0)</span
              >
            </h2>
            <div
              style="
                display: flex;
                gap: 1rem;
                align-items: center;
                flex-wrap: wrap;
              "
            >
              <input
                type="text"
                id="shopSearch"
                placeholder="Search shops..."
                style="
                  padding: 8px 12px;
                  border-radius: 8px;
                  background: rgba(255, 255, 255, 0.1);
                  color: #fff;
                  border: 1px solid rgba(255, 255, 255, 0.2);
                  min-width: 200px;
                "
              />
              <select
                id="shopFilter"
                style="
                  padding: 8px 12px;
                  border-radius: 8px;
                  background: rgba(255, 255, 255, 0.1);
                  color: #fff;
                  border: 1px solid rgba(255, 255, 255, 0.2);
                  cursor: pointer;
                "
              >
                <option value="all">All Categories</option>
                <option value="electronics">Electronics</option>
                <option value="fashion">Fashion</option>
                <option value="hostel">Hostels</option>
              </select>
              <button
                id="unfollowAllBtn"
                class="btn btn-secondary"
                style="padding: 8px 16px; font-size: 0.9rem"
              >
                Unfollow All
              </button>
            </div>
          </div>
          <div
            id="followedGrid"
            style="
              display: grid;
              grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
              gap: 2rem;
              padding: 2rem 0;
            "
          >
            <p style="grid-column: 1/-1; text-align: center; color: #aaa">
              Loading...
            </p>
          </div>
        </div>

        <!-- SETTINGS -->
        <div id="settings" class="section card">
          <h2
            style="
              margin-bottom: 2rem;
              display: flex;
              align-items: center;
              gap: 0.75rem;
            "
          >
            <i class="fas fa-cog" style="color: var(--green-light)"></i>
            Account Settings
          </h2>

          <!-- Security Section -->
          <div
            style="
              background: rgba(255, 255, 255, 0.08);
              border-radius: 16px;
              padding: 2rem;
              margin-bottom: 1.5rem;
              border-left: 4px solid #3498db;
            "
          >
            <h3
              style="
                margin-bottom: 1.5rem;
                display: flex;
                align-items: center;
                gap: 0.5rem;
                font-size: 1.2rem;
              "
            >
              <i class="fas fa-shield-alt" style="color: #3498db"></i>
              Security
            </h3>
            <div class="form-group">
              <label
                style="font-weight: 600; margin-bottom: 0.75rem; display: block"
              >
                <i
                  class="fas fa-key"
                  style="margin-right: 0.5rem; color: var(--green-light)"
                ></i>
                Change Password
              </label>
              <div style="position: relative; margin-bottom: 0.75rem">
                <input
                  type="password"
                  id="currentPassword"
                  placeholder="Current password"
                  style="padding-right: 3rem; margin-bottom: 0"
                />
                <button
                  type="button"
                  onclick="togglePasswordVisibility('currentPassword')"
                  style="
                    position: absolute;
                    right: 12px;
                    top: 50%;
                    transform: translateY(-50%);
                    background: none;
                    border: none;
                    color: #aaa;
                    cursor: pointer;
                    font-size: 1.1rem;
                  "
                >
                  <i class="fas fa-eye"></i>
                </button>
              </div>
              <div style="position: relative; margin-bottom: 0.75rem">
                <input
                  type="password"
                  id="newPassword"
                  placeholder="New password (min 6 characters)"
                  style="padding-right: 3rem; margin-bottom: 0"
                />
                <button
                  type="button"
                  onclick="togglePasswordVisibility('newPassword')"
                  style="
                    position: absolute;
                    right: 12px;
                    top: 50%;
                    transform: translateY(-50%);
                    background: none;
                    border: none;
                    color: #aaa;
                    cursor: pointer;
                    font-size: 1.1rem;
                  "
                >
                  <i class="fas fa-eye"></i>
                </button>
              </div>
              <div style="position: relative">
                <input
                  type="password"
                  id="confirmPassword"
                  placeholder="Confirm new password"
                  style="padding-right: 3rem; margin-bottom: 0"
                />
                <button
                  type="button"
                  onclick="togglePasswordVisibility('confirmPassword')"
                  style="
                    position: absolute;
                    right: 12px;
                    top: 50%;
                    transform: translateY(-50%);
                    background: none;
                    border: none;
                    color: #aaa;
                    cursor: pointer;
                    font-size: 1.1rem;
                  "
                >
                  <i class="fas fa-eye"></i>
                </button>
              </div>
              <button
                id="changePasswordBtn"
                class="btn btn-primary"
                style="margin-top: 1.25rem; width: 100%; max-width: 300px"
              >
                <i class="fas fa-check-circle" style="margin-right: 0.5rem"></i>
                Update Password
              </button>
            </div>
          </div>

          <!-- Verification & Trust Section -->
          <div style="background: rgba(255, 255, 255, 0.08); border-radius: 16px; padding: 2rem; margin-bottom: 1.5rem; border-left: 4px solid #27ae60;">
            <h3 style="margin-bottom: 1.5rem; display: flex; align-items: center; gap: 0.5rem; font-size: 1.2rem;">
              <i class="fas fa-shield-check" style="color: #27ae60"></i>
              Verification & Trust
            </h3>
            <div style="display: flex; flex-direction: column; gap: 1rem">
              <div style="display: flex; align-items: center; justify-content: space-between; padding: 1rem; background: rgba(255, 255, 255, 0.05); border-radius: 12px;">
                <div>
                  <div style="font-weight: 600; margin-bottom: 0.25rem;">üì± Phone Verification</div>
                  <div style="font-size: 0.85rem; color: #aaa;">Verify your phone number for trust</div>
                </div>
                <button id="verifyPhoneBtn" class="btn btn-primary" style="padding: 8px 16px; font-size: 0.85rem;">Verify</button>
              </div>
              <div style="display: flex; align-items: center; justify-content: space-between; padding: 1rem; background: rgba(255, 255, 255, 0.05); border-radius: 12px;">
                <div>
                  <div style="font-weight: 600; margin-bottom: 0.25rem;">‚úâÔ∏è Email Verification</div>
                  <div style="font-size: 0.85rem; color: #aaa;">Verify your email address</div>
                </div>
                <button id="verifyEmailBtn" class="btn btn-primary" style="padding: 8px 16px; font-size: 0.85rem;">Verify</button>
              </div>
              <div style="display: flex; align-items: center; justify-content: space-between; padding: 1rem; background: rgba(255, 255, 255, 0.05); border-radius: 12px;">
                <div>
                  <div style="font-weight: 600; margin-bottom: 0.25rem;">üéì Student ID Verification</div>
                  <div style="font-size: 0.85rem; color: #aaa;">Upload student ID for campus verification</div>
                </div>
                <button id="verifyStudentBtn" class="btn btn-primary" style="padding: 8px 16px; font-size: 0.85rem;">Upload</button>
              </div>
            </div>
          </div>

          <!-- Privacy & Safety Section -->
          <div style="background: rgba(255, 255, 255, 0.08); border-radius: 16px; padding: 2rem; margin-bottom: 1.5rem; border-left: 4px solid #9b59b6;">
            <h3 style="margin-bottom: 1.5rem; display: flex; align-items: center; gap: 0.5rem; font-size: 1.2rem;">
              <i class="fas fa-user-shield" style="color: #9b59b6"></i>
              Privacy & Safety
            </h3>
            <div style="display: flex; flex-direction: column; gap: 1rem">
              <div style="padding: 1rem; background: rgba(255, 255, 255, 0.05); border-radius: 12px;">
                <label style="font-weight: 600; margin-bottom: 0.75rem; display: block;">üëÅÔ∏è Profile Visibility</label>
                <select id="profileVisibility" style="width: 100%; padding: 8px 12px; border-radius: 8px; background: rgba(255,255,255,0.1); color: #fff; border: 1px solid rgba(255,255,255,0.2);">
                  <option value="public">Public - Everyone can see</option>
                  <option value="campus">Campus Only - Students only</option>
                  <option value="private">Private - Hidden profile</option>
                </select>
              </div>
              <div style="padding: 1rem; background: rgba(255, 255, 255, 0.05); border-radius: 12px;">
                <label style="font-weight: 600; margin-bottom: 0.75rem; display: block;">üí¨ Who Can Contact Me</label>
                <select id="contactPrefs" style="width: 100%; padding: 8px 12px; border-radius: 8px; background: rgba(255,255,255,0.1); color: #fff; border: 1px solid rgba(255,255,255,0.2);">
                  <option value="everyone">Everyone</option>
                  <option value="verified">Verified users only</option>
                  <option value="followed">Followed shops only</option>
                </select>
              </div>
              <label style="display: flex; align-items: center; gap: 0.75rem; cursor: pointer; padding: 1rem; background: rgba(255, 255, 255, 0.05); border-radius: 12px;">
                <input type="checkbox" id="showRealName" style="width: 20px; height: 20px; cursor: pointer" />
                <div>
                  <div style="font-weight: 600; margin-bottom: 0.25rem;">üè∑Ô∏è Show Real Name</div>
                  <div style="font-size: 0.85rem; color: #aaa;">Display your real name to other users</div>
                </div>
              </label>
            </div>
            <button id="savePrivacyBtn" class="btn btn-primary" style="margin-top: 1.5rem; width: 100%; max-width: 300px;">
              <i class="fas fa-save" style="margin-right: 0.5rem"></i>
              Save Privacy Settings
            </button>
          </div>

          <!-- Safety Features Section -->
          <div style="background: rgba(255, 255, 255, 0.08); border-radius: 16px; padding: 2rem; margin-bottom: 1.5rem; border-left: 4px solid #e67e22;">
            <h3 style="margin-bottom: 1.5rem; display: flex; align-items: center; gap: 0.5rem; font-size: 1.2rem;">
              <i class="fas fa-map-marker-alt" style="color: #e67e22"></i>
              Safety Features
            </h3>
            <div style="display: flex; flex-direction: column; gap: 1rem">
              <div style="padding: 1rem; background: rgba(255, 255, 255, 0.05); border-radius: 12px;">
                <label style="font-weight: 600; margin-bottom: 0.75rem; display: block;">üìç Preferred Meeting Locations</label>
                <textarea id="meetingLocations" placeholder="e.g. Main Library, Student Center, Cafeteria..." style="width: 100%; min-height: 80px; padding: 12px; border-radius: 8px; background: rgba(255,255,255,0.1); color: #fff; border: 1px solid rgba(255,255,255,0.2); font-family: inherit; resize: vertical;"></textarea>
              </div>
              <div style="padding: 1rem; background: rgba(255, 255, 255, 0.05); border-radius: 12px;">
                <label style="font-weight: 600; margin-bottom: 0.75rem; display: block;">üö® Emergency Contact</label>
                <input type="text" id="emergencyContact" placeholder="Friend's phone number" style="width: 100%; padding: 8px 12px; border-radius: 8px; background: rgba(255,255,255,0.1); color: #fff; border: 1px solid rgba(255,255,255,0.2);" />
              </div>
              <div style="display: flex; gap: 1rem;">
                <button id="viewBlockedBtn" class="btn btn-secondary" style="flex: 1; padding: 8px 16px; font-size: 0.9rem;">
                  <i class="fas fa-ban"></i> View Blocked Users
                </button>
                <button id="reportUserBtn" class="btn btn-secondary" style="flex: 1; padding: 8px 16px; font-size: 0.9rem;">
                  <i class="fas fa-flag"></i> Report User
                </button>
              </div>
            </div>
            <button id="saveSafetyBtn" class="btn btn-primary" style="margin-top: 1.5rem; width: 100%; max-width: 300px;">
              <i class="fas fa-save" style="margin-right: 0.5rem"></i>
              Save Safety Settings
            </button>
          </div>

          <!-- Notifications Section -->
          <div style="background: rgba(255, 255, 255, 0.08); border-radius: 16px; padding: 2rem; margin-bottom: 1.5rem; border-left: 4px solid #f39c12;">
            <h3 style="margin-bottom: 1.5rem; display: flex; align-items: center; gap: 0.5rem; font-size: 1.2rem;">
              <i class="fas fa-bell" style="color: #f39c12"></i>
              Notification Preferences
            </h3>
            <div style="display: flex; flex-direction: column; gap: 1rem">
              <label style="display: flex; align-items: center; gap: 0.75rem; cursor: pointer; padding: 1rem; background: rgba(255, 255, 255, 0.05); border-radius: 12px;">
                <input type="checkbox" id="notifOrders" checked style="width: 20px; height: 20px; cursor: pointer" />
                <div>
                  <div style="font-weight: 600; margin-bottom: 0.25rem;">üì¶ Order Updates</div>
                  <div style="font-size: 0.85rem; color: #aaa;">Get notified about order status changes</div>
                </div>
              </label>
              <label style="display: flex; align-items: center; gap: 0.75rem; cursor: pointer; padding: 1rem; background: rgba(255, 255, 255, 0.05); border-radius: 12px;">
                <input type="checkbox" id="notifSafety" checked style="width: 20px; height: 20px; cursor: pointer" />
                <div>
                  <div style="font-weight: 600; margin-bottom: 0.25rem;">üõ°Ô∏è Safety Tips</div>
                  <div style="font-size: 0.85rem; color: #aaa;">Receive periodic safety reminders</div>
                </div>
              </label>
              <label style="display: flex; align-items: center; gap: 0.75rem; cursor: pointer; padding: 1rem; background: rgba(255, 255, 255, 0.05); border-radius: 12px;">
                <input type="checkbox" id="notifVerification" checked style="width: 20px; height: 20px; cursor: pointer" />
                <div>
                  <div style="font-weight: 600; margin-bottom: 0.25rem;">‚úÖ Verification Reminders</div>
                  <div style="font-size: 0.85rem; color: #aaa;">Reminders to complete profile verification</div>
                </div>
              </label>
              <label style="display: flex; align-items: center; gap: 0.75rem; cursor: pointer; padding: 1rem; background: rgba(255, 255, 255, 0.05); border-radius: 12px;">
                <input type="checkbox" id="notifPromotions" style="width: 20px; height: 20px; cursor: pointer" />
                <div>
                  <div style="font-weight: 600; margin-bottom: 0.25rem;">üéâ Promotions & Deals</div>
                  <div style="font-size: 0.85rem; color: #aaa;">Receive exclusive offers and discounts</div>
                </div>
              </label>
            </div>
            <button id="saveNotifBtn" class="btn btn-primary" style="margin-top: 1.5rem; width: 100%; max-width: 300px;">
              <i class="fas fa-save" style="margin-right: 0.5rem"></i>
              Save Preferences
            </button>
          </div>

          <!-- Trust Score Section -->
          <div style="background: rgba(255, 255, 255, 0.08); border-radius: 16px; padding: 2rem; margin-bottom: 1.5rem; border-left: 4px solid #3498db;">
            <h3 style="margin-bottom: 1.5rem; display: flex; align-items: center; gap: 0.5rem; font-size: 1.2rem;">
              <i class="fas fa-star" style="color: #3498db"></i>
              Trust & Reputation
            </h3>
            <div style="display: flex; flex-direction: column; gap: 1rem">
              <div class="trust-score-display"></div>
              <div style="padding: 1rem; background: rgba(255, 255, 255, 0.05); border-radius: 12px; text-align: center;">
                <div style="font-size: 2rem; margin-bottom: 0.5rem;">‚≠ê</div>
                <div style="font-weight: 600; font-size: 1.5rem; color: var(--green-light);">4.8</div>
                <div style="font-size: 0.9rem; color: #aaa;">Trust Score</div>
              </div>
              <label style="display: flex; align-items: center; gap: 0.75rem; cursor: pointer; padding: 1rem; background: rgba(255, 255, 255, 0.05); border-radius: 12px;">
                <input type="checkbox" id="showTrustScore" checked style="width: 20px; height: 20px; cursor: pointer" />
                <div>
                  <div style="font-weight: 600; margin-bottom: 0.25rem;">üìä Show Trust Score</div>
                  <div style="font-size: 0.85rem; color: #aaa;">Display your trust score to other users</div>
                </div>
              </label>
              <div style="display: flex; gap: 1rem;">
                <button id="viewBadgesBtn" class="btn btn-secondary" style="flex: 1; padding: 8px 16px; font-size: 0.9rem;">
                  <i class="fas fa-medal"></i> View Badges
                </button>
                <button id="interactionHistoryBtn" class="btn btn-secondary" style="flex: 1; padding: 8px 16px; font-size: 0.9rem;">
                  <i class="fas fa-history"></i> Interaction History
                </button>
              </div>
            </div>
            <button id="saveTrustBtn" class="btn btn-primary" style="margin-top: 1.5rem; width: 100%; max-width: 300px;">
              <i class="fas fa-save" style="margin-right: 0.5rem"></i>
              Save Trust Settings
            </button>
          </div>

          <!-- Danger Zone -->
          <div
            style="
              background: rgba(231, 76, 60, 0.1);
              border-radius: 16px;
              padding: 2rem;
              border-left: 4px solid var(--error);
            "
          >
            <h3
              style="
                margin-bottom: 1rem;
                display: flex;
                align-items: center;
                gap: 0.5rem;
                font-size: 1.2rem;
                color: var(--error);
              "
            >
              <i class="fas fa-exclamation-triangle"></i>
              Danger Zone
            </h3>
            <p style="color: #ccc; margin-bottom: 1.5rem; line-height: 1.6">
              Once you delete your account, there is no going back. Please be
              certain.
            </p>
            <button
              id="deleteAccountBtn"
              class="btn btn-cancel"
              style="width: 100%; max-width: 300px"
            >
              <i class="fas fa-trash-alt" style="margin-right: 0.5rem"></i>
              Delete Account
            </button>
          </div>
        </div>

        <!-- HELP -->
        <div id="help" class="section card">
          <h2 style="margin-bottom: 2rem">Help & Support</h2>
          <div style="display: flex; flex-direction: column; gap: 1.5rem">
            <div
              style="
                background: rgba(255, 255, 255, 0.08);
                padding: 1.5rem;
                border-radius: 12px;
              "
            >
              <h3 style="margin-bottom: 1rem">üìö FAQs</h3>
              <details style="margin-bottom: 0.75rem">
                <summary style="cursor: pointer; font-weight: 600">
                  How do I track my order?
                </summary>
                <p style="margin-top: 0.5rem; color: #ccc">
                  Go to My Orders and click the Track button on any accepted
                  order.
                </p>
              </details>
              <details style="margin-bottom: 0.75rem">
                <summary style="cursor: pointer; font-weight: 600">
                  Can I cancel an order?
                </summary>
                <p style="margin-top: 0.5rem; color: #ccc">
                  Yes, you can cancel pending orders from the My Orders section.
                </p>
              </details>
              <details style="margin-bottom: 0.75rem">
                <summary style="cursor: pointer; font-weight: 600">
                  How do I contact a seller?
                </summary>
                <p style="margin-top: 0.5rem; color: #ccc">
                  Visit the product page and click the WhatsApp or Email button.
                </p>
              </details>
              <details>
                <summary style="cursor: pointer; font-weight: 600">
                  What payment methods are accepted?
                </summary>
                <p style="margin-top: 0.5rem; color: #ccc">
                  We support Mobile Money, Bank Transfer, and Cash on Delivery.
                </p>
              </details>
            </div>
            <div
              style="
                background: rgba(255, 255, 255, 0.08);
                padding: 1.5rem;
                border-radius: 12px;
              "
            >
              <h3 style="margin-bottom: 1rem">üìû Contact Support</h3>
              <div class="form-group">
                <input type="text" id="supportSubject" placeholder="Subject" />
                <textarea
                  id="supportMessage"
                  placeholder="Describe your issue..."
                  style="
                    width: 100%;
                    min-height: 120px;
                    padding: 14px 16px;
                    border: none;
                    border-radius: 12px;
                    background: rgba(255, 255, 255, 0.15);
                    color: #fff;
                    font-size: 1rem;
                    margin-top: 0.5rem;
                    font-family: inherit;
                    resize: vertical;
                  "
                ></textarea>
                <button
                  id="submitSupportBtn"
                  class="btn btn-primary"
                  style="margin-top: 1rem"
                >
                  Submit Ticket
                </button>
              </div>
            </div>
            <div
              style="
                background: rgba(110, 207, 69, 0.1);
                padding: 1.5rem;
                border-radius: 12px;
                border-left: 4px solid var(--green-light);
              "
            >
              <h3 style="margin-bottom: 0.5rem">üõ°Ô∏è Safety Tips</h3>
              <ul style="color: #ccc; line-height: 1.8; padding-left: 1.5rem">
                <li>Meet sellers in public campus locations</li>
                <li>Inspect items before payment</li>
                <li>Never share passwords or OTPs</li>
                <li>Report suspicious activity immediately</li>
              </ul>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div id="trackingModal" class="modal" style="display: none">
      <div class="modal-content">
        <span class="close">&times;</span>
        <div class="modal-body"></div>
      </div>
    </div>

    <div class="whatsapp-float">
      <button id="whatsappFloatBtn">
        <i class="fab fa-whatsapp"></i>
      </button>
    </div>
    <script src="../assets/js/purchase-verification.js"></script>
    <script>
      const $ = (id) => document.getElementById(id);

      // XSS Protection Helper
      const escapeHtml = (str) => {
        const div = document.createElement("div");
        div.textContent = str;
        return div.innerHTML;
      };

      // Custom confirm modal
      const showConfirmModal = (message, onConfirm) => {
        const modal = document.createElement("div");
        modal.style.cssText =
          "position:fixed;inset:0;background:rgba(0,0,0,0.7);display:flex;align-items:center;justify-content:center;z-index:10001;";
        modal.innerHTML = `
          <div style="background:#1a1a1a;padding:2rem;border-radius:16px;max-width:400px;box-shadow:0 20px 60px rgba(0,0,0,0.5);">
            <p style="color:#fff;font-size:1.1rem;margin-bottom:1.5rem;white-space:pre-line;">${escapeHtml(
              message
            )}</p>
            <div style="display:flex;gap:1rem;justify-content:flex-end;">
              <button class="cancel-btn" style="padding:0.75rem 1.5rem;background:rgba(255,255,255,0.1);color:#fff;border:none;border-radius:8px;cursor:pointer;">Cancel</button>
              <button class="confirm-btn" style="padding:0.75rem 1.5rem;background:#6ecf45;color:#000;border:none;border-radius:8px;cursor:pointer;font-weight:600;">Confirm</button>
            </div>
          </div>
        `;
        document.body.appendChild(modal);
        modal.querySelector(".cancel-btn").onclick = () => modal.remove();
        modal.querySelector(".confirm-btn").onclick = () => {
          modal.remove();
          onConfirm();
        };
        modal.onclick = (e) => {
          if (e.target === modal) modal.remove();
        };
      };

      // Custom alert modal
      const showAlertModal = (message) => {
        const modal = document.createElement("div");
        modal.style.cssText =
          "position:fixed;inset:0;background:rgba(0,0,0,0.7);display:flex;align-items:center;justify-content:center;z-index:10001;";
        modal.innerHTML = `
          <div style="background:#1a1a1a;padding:2rem;border-radius:16px;max-width:400px;box-shadow:0 20px 60px rgba(0,0,0,0.5);">
            <p style="color:#fff;font-size:1.1rem;margin-bottom:1.5rem;white-space:pre-line;">${escapeHtml(
              message
            )}</p>
            <div style="display:flex;justify-content:flex-end;">
              <button class="ok-btn" style="padding:0.75rem 1.5rem;background:#6ecf45;color:#000;border:none;border-radius:8px;cursor:pointer;font-weight:600;">OK</button>
            </div>
          </div>
        `;
        document.body.appendChild(modal);
        modal.querySelector(".ok-btn").onclick = () => modal.remove();
        modal.onclick = (e) => {
          if (e.target === modal) modal.remove();
        };
      };

      const API = "http://localhost:5000/api";
      const WS_URL = "ws://localhost:5000/notifications";

      // === GLOBAL ELEMENTS ===
      const notifSidebar = $("notificationSidebar");
      const notifBtn = $("notificationBtn");
      const notifBadge = $("notificationBadge");
      const mobileMenu = $("mobileMenu");
      const overlay = $("overlay");

      // === AUTH & USER ===
      let user = JSON.parse(
        localStorage.getItem("currentUser") ||
          sessionStorage.getItem("currentUser") ||
          "{}"
      );

      if (!user?.token || user.role !== "buyer") {
        location.replace("../REGISTRY_PAGES/Sign_in.html");
      }

      // Auto logout on 401
      const originalFetch = window.fetch;
      window.fetch = (...args) =>
        originalFetch(...args).catch((err) => {
          if (err.message.includes("401")) {
            toast("Session expired ‚Äì please log in again", "error");
            localStorage.clear();
            sessionStorage.clear();
            setTimeout(
              () => location.replace("../REGISTRY_PAGES/Sign_in.html"),
              1000
            );
          }
          throw err;
        });

      const token = user.token;
      const buyerId = user?.id;

      // === TOAST SYSTEM ===
      const toast = (msg, type = "success") => {
        const t = $("toast");
        t.textContent = msg;
        t.className = `toast ${type} show`;
        setTimeout(() => (t.className = "toast"), 3000);
      };

      // === LOAD USER DATA ===
      const loadUserData = () => {
        const pic = user.profilePic
          ? `http://localhost:5000${user.profilePic}`
          : "../PROFILE_PAGES/default_account_picture/account.png";

        $("profilePic").src =
          $("headerAvatar").src =
          $("editProfilePicPreview").src =
            pic;

        $("buyerName").textContent = user.name?.split(" ")[0] || "Friend üëã";
        $("fullName").textContent = user.name || "Valued Buyer";
        $("userName").textContent = user.name || "Valued Buyer";
        $("indexNum").textContent = user.index_num || "N/A";
        $("userRole").textContent =
          user.role?.charAt(0).toUpperCase() + user.role?.slice(1) || "Buyer";
        $("email").textContent = user.email || "email@dex.com";
        $("phone").textContent = user.number || "N/A";
        $("address").textContent = user.address || "N/A";
      };
      loadUserData();

      // === DEBOUNCE HELPER ===
      const debounce = (fn, delay) => {
        let timeout;
        return (...args) => {
          clearTimeout(timeout);
          timeout = setTimeout(() => fn(...args), delay);
        };
      };

      // === RESILIENT FETCH ===
      const fetchWithRetry = async (
        url,
        options = {},
        retries = 3,
        delayMs = 500
      ) => {
        for (let i = 0; i < retries; i++) {
          try {
            const res = await fetch(url, options);
            if (!res.ok) throw new Error(`HTTP ${res.status}`);
            return await res.json();
          } catch (err) {
            if (i === retries - 1) throw err;
            await new Promise((r) => setTimeout(r, delayMs));
          }
        }
      };

      // === SECTION SWITCHING ===
      const switchSection = (id) => {
        document
          .querySelectorAll(".section")
          .forEach((s) => s.classList.remove("active"));

        document
          .querySelectorAll(".sidebar a, .mobile-menu a")
          .forEach((a) => a.classList.remove("active"));

        $(id).classList.add("active");

        document
          .querySelectorAll(`[data-section="${id}"]`)
          .forEach((a) => a.classList.add("active"));

        if (id === "orders") fetchOrders();
        if (id === "wishlist") fetchWishlist();
        if (id === "recent") loadRecentlyViewed();
        if (id === "bookings") loadBookings();
        if (id === "followed") loadFollowedShops();
        if (id === "settings") loadSettings();
        if (id === "help") loadHelp();
      };

      document.querySelectorAll("[data-section]").forEach((el) =>
        el.addEventListener("click", (e) => {
          e.preventDefault();
          switchSection(el.dataset.section);
        })
      );

      // === EDIT PROFILE ===
      $("editProfileBtn").onclick = () => {
        $("editName").value = user.name || "";
        $("editEmail").value = user.email || "";
        $("editPhone").value = user.number || "";
        $("editAddress").value = user.address || "";
        switchSection("editProfile");
      };

      $("cancelEditBtn").onclick = () => switchSection("profile");

      $("saveProfileBtn").onclick = async () => {
        const btn = $("saveProfileBtn");
        const loading = $("saveLoading");

        btn.disabled = true;
        loading.style.display = "inline-block";

        const updated = {
          name: $("editName").value.trim(),
          email: $("editEmail").value.trim(),
          number: $("editPhone").value.trim(),
          address: $("editAddress").value.trim(),
        };

        try {
          const data = await fetchWithRetry(`${API}/buyers/profile`, {
            method: "PUT",
            headers: {
              "Content-Type": "application/json",
              Authorization: `Bearer ${token}`,
            },
            body: JSON.stringify(updated),
          });

          Object.assign(user, data);
          localStorage.setItem("currentUser", JSON.stringify(user));
          sessionStorage.setItem("currentUser", JSON.stringify(user));

          loadUserData();
          toast("Profile updated successfully ‚ú®", "success");
          switchSection("profile");
        } catch (err) {
          toast("Update failed ‚ùå", "error");
        }

        btn.disabled = false;
        loading.style.display = "none";
      };

      // === PROFILE PICTURE UPLOAD ===
      const uploadPic = async (file) => {
        const fd = new FormData();
        fd.append("profilePic", file);

        try {
          const data = await fetchWithRetry(`${API}/buyers/profile/picture`, {
            method: "POST",
            headers: { Authorization: `Bearer ${token}` },
            body: fd,
          });

          user.profilePic = data.profilePic;
          localStorage.setItem("currentUser", JSON.stringify(user));
          sessionStorage.setItem("currentUser", JSON.stringify(user));

          loadUserData();
          toast("Picture updated üì∏", "success");
        } catch {
          toast("Upload failed ‚ùå", "error");
        }
      };

      $("picInput").onchange = (e) =>
        e.target.files[0] && uploadPic(e.target.files[0]);
      $("editPicInput").onchange = (e) =>
        e.target.files[0] && uploadPic(e.target.files[0]);

      // === NOTIFICATIONS ===
      const buyerNotificationSystem = (() => {
        let notifications = [];
        let ws = null;

        const updateUI = () => {
          const unread = notifications.filter((n) => !n.read).length;

          notifBadge.textContent = unread > 99 ? "99+" : unread;
          notifBadge.style.display = unread ? "grid" : "none";

          const list = $("notificationList");
          list.innerHTML = "";

          if (!notifications.length) {
            $("emptyState").style.display = "block";
            return;
          }

          $("emptyState").style.display = "none";

          notifications.forEach((notif, idx) => {
            const item = document.createElement("div");
            item.className = `notif-item ${notif.read ? "" : "unread"}`;
            item.dataset.id = notif.id;

            const timeStr = new Date(notif.createdAt).toLocaleString([], {
              month: "short",
              day: "numeric",
              hour: "2-digit",
              minute: "2-digit",
            });
            const typeConfig = {
              order: { emoji: "üõí", color: "order" },
              message: { emoji: "‚úâÔ∏è", color: "message" },
              review: { emoji: "‚≠ê", color: "review" },
              verification: { emoji: "‚úÖ", color: "system" },
              system: { emoji: "üì¢", color: "system" },
              error: { emoji: "‚ö†Ô∏è", color: "error" },
            };
            const config = typeConfig[notif.type] || {
              emoji: "üîî",
              color: "system",
            };

            item.innerHTML = `
              <div class="notif-inner">
                <div class="notif-icon ${config.color}"></div>
                <div class="notif-content">
                  <h4>${notif.title || "Notification"}</h4>
                  <p>${notif.message}</p>
                  <div class="notif-time">${timeStr}</div>
                </div>
              </div>
            `;
            item.querySelector(".notif-icon").textContent = config.emoji;

            item.onclick = () => markAsRead(notif.id);
            list.appendChild(item);
            setTimeout(() => item.classList.add("visible"), idx * 50);
          });
        };

        const markAsRead = async (id) => {
          try {
            await fetch(`${API}/notifications/${id}/read`, {
              method: "POST",
              headers: { Authorization: `Bearer ${token}` },
            });
          } catch {}

          notifications = notifications.map((n) =>
            n.id === id ? { ...n, read: true } : n
          );
          updateUI();
        };

        const clearAll = async () => {
          showConfirmModal("Clear all notifications?", async () => {
            try {
              await fetch(`${API}/notifications/clear`, {
                method: "POST",
                headers: { Authorization: `Bearer ${token}` },
              });
              notifications = [];
              updateUI();
            } catch {}
          });
        };

        const connectWS = () => {
          try {
            ws = new WebSocket(`${WS_URL}?token=${token}`);

            ws.onmessage = (msg) => {
              const notif = JSON.parse(msg.data);
              notifications.unshift(notif);
              updateUI();
            };

            ws.onclose = () => setTimeout(connectWS, 3000);
          } catch {
            console.warn("WebSocket failed");
          }
        };

        const fetchNotifications = async () => {
          try {
            const { notifications: server } = await fetchWithRetry(
              `${API}/notifications`,
              {
                headers: { Authorization: `Bearer ${token}` },
              }
            );
            notifications = server;
            updateUI();
          } catch {}
        };

        notifBtn.onclick = (e) => {
          e.stopPropagation();
          const open = !notifSidebar.classList.contains("open");

          notifSidebar.classList.toggle("open", open);
          mobileMenu.classList.remove("open");
          overlay.classList.toggle("active", open);

          if (open) fetchNotifications();
        };

        $("clearAllBtn").onclick = clearAll;

        connectWS();
        setInterval(fetchNotifications, 15000);
        fetchNotifications();

        return { refresh: fetchNotifications };
      })();

      // === ORDERS ===
      const fetchOrders = async () => {
        const activeGrid = $("activeOrdersGrid");
        const deliveredGrid = $("deliveredOrdersGrid");
        const cancelledGrid = $("cancelledOrdersGrid");

        activeGrid.innerHTML =
          deliveredGrid.innerHTML =
          cancelledGrid.innerHTML =
            '<p style="grid-column:1/-1;text-align:center;color:#aaa">Loading...</p>';

        try {
          const orders = await fetchWithRetry(`${API}/orders`, {
            headers: { Authorization: `Bearer ${token}` },
          });

          const active = orders.filter(
            (o) => o.status === "pending" || o.status === "accepted"
          );
          const delivered = orders.filter((o) => o.status === "delivered");
          const cancelled = orders.filter(
            (o) => o.status === "rejected" || o.status === "cancelled"
          );

          const deliveredBadge = $("buyerDeliveredBadge");
          const rejectedBadge = $("buyerRejectedBadge");

          if (deliveredBadge) {
            deliveredBadge.textContent = delivered.length;
            deliveredBadge.style.display =
              delivered.length > 0 ? "flex" : "none";
          }

          if (rejectedBadge) {
            rejectedBadge.textContent = cancelled.length;
            rejectedBadge.style.display =
              cancelled.length > 0 ? "flex" : "none";
          }

          renderOrders(active, activeGrid);
          renderOrders(delivered, deliveredGrid);
          renderOrders(cancelled, cancelledGrid, true);
        } catch (err) {
          activeGrid.innerHTML =
            deliveredGrid.innerHTML =
            cancelledGrid.innerHTML =
              '<p style="grid-column:1/-1;text-align:center;color:#aaa">Failed to load.</p>';
        }
      };

      const renderOrders = (orders, container, isCancelled = false) => {
        container.innerHTML = "";
        container.className = "grid order";
        if (!orders.length) {
          const emptyMessages = {
            active:
              '<p style="grid-column:1/-1;text-align:center;padding:3rem;color:#aaa"><i class="fas fa-shopping-bag" style="font-size:3rem;opacity:0.3;display:block;margin-bottom:1rem"></i>No active orders üõçÔ∏è</p>',
            delivered:
              '<p style="grid-column:1/-1;text-align:center;padding:3rem;color:#aaa"><i class="fas fa-truck" style="font-size:3rem;opacity:0.3;display:block;margin-bottom:1rem"></i>No delivered orders yet üì¶</p>',
            cancelled:
              '<p style="grid-column:1/-1;text-align:center;padding:3rem;color:#aaa"><i class="fas fa-times-circle" style="font-size:3rem;opacity:0.3;display:block;margin-bottom:1rem"></i>No cancelled/rejected orders üö´</p>',
          };
          container.innerHTML = isCancelled
            ? emptyMessages.cancelled
            : container.id === "deliveredOrdersGrid"
            ? emptyMessages.delivered
            : emptyMessages.active;
          return;
        }

        orders.forEach((order) => {
          const card = document.createElement("div");
          card.className = "order-card";
          card.dataset.orderId = order.id;
          card.dataset.sellerPhone = order.sellerPhone || "";
          const imgSrc = order.product?.images?.[0]
            ? `${BACKEND_URL}${order.product.images[0]}`
            : order.image ||
              "https://via.placeholder.com/300x180?text=No+Image";
          const srcset = imgSrc.includes("placeholder")
            ? ""
            : `${imgSrc} 300w, ${imgSrc} 600w`;

          card.innerHTML = `
            <img src="${imgSrc}"
                 srcset="${srcset}"
                 sizes="(max-width: 768px) 100vw, 300px"
                 alt="${escapeHtml(order.productName || "")}"
                 width="300" height="180"
                 loading="lazy"
                 decoding="async"
                 onerror="this.src='https://via.placeholder.com/300x180?text=No+Image'">
            <div class="order-details">
              <strong>${escapeHtml(
                order.product?.name || order.productName || ""
              )}</strong>
              <span>Seller: ${escapeHtml(order.sellerName || "")}</span>
              <span>Qty: ${order.quantity}</span>
              <span>Total: ‚Çµ${order.totalPrice.toFixed(2)}</span>
              <span class="order-status status-${
                order.status
              }">${order.status.toUpperCase()}</span>
            </div>
            <div class="order-actions">
              ${
                !isCancelled && order.status === "pending"
                  ? `<button class="chat-btn-buyer" style="background:#6ecf45;color:#000;padding:8px 16px;border:none;border-radius:8px;font-weight:600;cursor:pointer;margin-right:0.5rem;">üí¨ Chat</button><button class="btn btn-cancel" data-id="${order.id}">Cancel</button>`
                  : ""
              }
              ${
                !isCancelled &&
                (order.status === "accepted" || order.status === "delivered")
                  ? `<button class="btn btn-track" data-id="${order.id}">Track</button>`
                  : ""
              }
            </div>
          `;
          container.appendChild(card);
        });

        // === CANCEL & TRACK EVENTS ===
        container.querySelectorAll(".btn-cancel").forEach((b) =>
          b.addEventListener("click", async () => {
            const id = b.dataset.id;
            showConfirmModal("Cancel order?", async () => {
              try {
                await fetchWithRetry(`${API}/orders/${id}/cancel`, {
                  method: "PATCH",
                  headers: {
                    "Content-Type": "application/json",
                    Authorization: `Bearer ${token}`,
                  },
                });
                fetchOrders();
                toast("Order cancelled ‚ùå", "success");
              } catch (err) {
                console.error("Cancel order error:", err);
                toast("Failed to cancel order", "error");
              }
            });
          })
        );

        container.querySelectorAll(".btn-track").forEach((b) =>
          b.addEventListener("click", (e) => {
            const id = b.dataset.id;
            const modal = $("trackingModal");
            modal.querySelector(".modal-body").innerHTML = `
          <p>Tracking order #${id}</p>
          <p>Status: In Transit üöö</p>
          <p>ETA: 2 days</p>
          <p>Carrier: Dex Express</p>
        `;
            modal.classList.add("open");
          })
        );

        container.querySelectorAll(".chat-btn-buyer").forEach((btn) => {
          btn.onclick = () => {
            const card = btn.closest(".order-card");
            const orderId = card.dataset.orderId;
            const sellerPhone = card.dataset.sellerPhone;
            if (window.OrderChat) {
              window.OrderChat.open(
                { id: orderId, sellerPhone: sellerPhone },
                "buyer",
                token
              );
            }
          };
        });
      };

      // TRACKING MODAL CLOSE
      $("trackingModal").querySelector(".close").onclick = () => {
        $("trackingModal").classList.remove("open");
      };

      // === DEBOUNCED SEARCH ===
      $("orderSearch").addEventListener(
        "input",
        debounce((e) => {
          const term = e.target.value.toLowerCase();
          document.querySelectorAll(".order-card").forEach((card) => {
            const text = card.textContent.toLowerCase();
            card.style.display = text.includes(term) ? "" : "none";
          });
        }, 300)
      );

      // === WISHLIST & RECENTLY VIEWED ===
      const RECENT_KEY = "recentlyViewed";
      const BACKEND_URL = "http://127.0.0.1:5000"; // <-- backend URL

      const fetchWishlist = async () => {
        const grid = $("wishlistGrid");
        grid.innerHTML =
          '<p style="grid-column:1/-1;text-align:center;color:#aaa">Loading...</p>';

        try {
          const items = await fetchWithRetry(`${API}/wishlist`, {
            headers: { Authorization: `Bearer ${token}` },
          });
          console.log("Wishlist items:", items);
          wishlistItems = items || [];
          allWishlistItems = items || [];
          renderWishlist(items);
        } catch (err) {
          console.error("Wishlist error:", err);
          grid.innerHTML =
            '<p style="grid-column:1/-1;text-align:center;color:#aaa">Failed to load wishlist.</p>';
        }
      };

      let wishlistItems = [];
      let allWishlistItems = [];

      const renderWishlist = (items) => {
        try {
          const grid = $("wishlistGrid");
          const count = $("wishlistCount");
          if (count) count.textContent = `(${items.length})`;
          grid.innerHTML = "";

          if (!items.length) {
            grid.innerHTML = `
      <p style="grid-column:1/-1; text-align:center; padding:80px 20px; color:#999; font-size:1.2rem;">
        <i class="fas fa-heart-broken" style="font-size:4rem; opacity:0.2; display:block; margin-bottom:20px;"></i>
        Your wishlist is empty üíî
      </p>`;
            return;
          }

          items.forEach((item) => {
            const product = item.product || item;
            const card = document.createElement("div");
            card.style.cssText = `
            background:rgba(255,255,255,0.08);border-radius:12px;overflow:hidden;
            transition:transform 0.3s,box-shadow 0.3s;cursor:pointer;
            box-shadow:0 4px 15px rgba(0,0,0,0.2);position:relative;
          `;
            card.onclick = () =>
              (location.href = `../Dex-product-details.html?id=${product.id}`);
            card.onmouseenter = () => {
              card.style.transform = "translateY(-8px)";
              card.style.boxShadow = "0 8px 25px rgba(0,0,0,0.4)";
            };
            card.onmouseleave = () => {
              card.style.transform = "";
              card.style.boxShadow = "0 4px 15px rgba(0,0,0,0.2)";
            };

            const imgSrc = product.images?.[0]
              ? `${BACKEND_URL}${product.images[0]}`
              : "https://via.placeholder.com/220x180/1a1a1a/666?text=No+Image";

            const productName = (product.name || "Product").replace(
              /'/g,
              "\\'"
            );
            const productPrice = Number(product.price || 0).toFixed(2);

            card.innerHTML = `
              <div style="position:relative">
                <img src="${imgSrc}" alt="${
              product.name || "Product"
            }" loading="lazy" style="width:100%;height:180px;object-fit:cover" onerror="this.src='https://via.placeholder.com/220x180/1a1a1a/666?text=No+Image'" />
                <button onclick="event.stopPropagation();removeFromWishlist(${
                  product.id
                })" style="position:absolute;top:8px;right:8px;background:rgba(0,0,0,0.8);border:none;color:#ff3b30;width:32px;height:32px;border-radius:50%;cursor:pointer;display:flex;align-items:center;justify-content:center;font-size:1.1rem"><i class="fas fa-heart"></i></button>
              </div>
              <div style="padding:12px">
                <strong style="font-size:0.95rem;display:block;margin-bottom:6px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;color:#fff">${
                  product.name || "Product"
                }</strong>
                <span style="color:var(--green-light);font-size:1.1rem;font-weight:700;display:block;margin-bottom:6px">‚Çµ${productPrice}</span>
                ${
                  product.subCategory
                    ? `<span style="background:rgba(110,207,69,0.2);color:var(--green-light);padding:4px 10px;border-radius:20px;font-size:0.75rem;display:inline-block;margin-bottom:8px">${product.subCategory}</span>`
                    : ""
                }
                <button onclick="event.stopPropagation();orderFromWishlist(${
                  product.id
                },'${productName}')"
                        style="width:100%;padding:8px;background:var(--green-light);color:#000;border:none;border-radius:8px;font-weight:600;cursor:pointer;font-size:0.85rem">
                  <i class="fas fa-shopping-cart"></i> Order Now
                </button>
              </div>
            `;
            grid.appendChild(card);
          });
        } catch (err) {
          console.error("Render wishlist error:", err);
          const grid = $("wishlistGrid");
          grid.innerHTML =
            '<p style="grid-column:1/-1;text-align:center;color:#aaa">Error displaying wishlist.</p>';
        }
      };

      window.removeFromWishlist = async (productId) => {
        showConfirmModal("Remove from wishlist?", async () => {
          try {
            await fetchWithRetry(`${API}/wishlist/${productId}`, {
              method: "DELETE",
              headers: { Authorization: `Bearer ${token}` },
            });
            toast("Removed from wishlist ‚ú®", "success");
            fetchWishlist();
          } catch (err) {
            console.error("Remove wishlist error:", err);
            toast("Failed to remove", "error");
          }
        });
      };

      window.orderFromWishlist = (productId, productName) => {
        // Check purchase eligibility first
        if (window.PurchaseVerification && user) {
          const product = allWishlistItems.find(item => (item.product?.id || item.id) === productId);
          if (product) {
            const price = product.product?.price || product.price || 0;
            const eligibility = window.PurchaseVerification.checkEligibility(price, user);
            if (!eligibility.allowed) {
              alert(eligibility.message);
              return;
            }
          }
        }
        
        if (window.openOrderModal) {
          window.openOrderModal(productId, productName);
        } else {
          location.href = `../Dex-product-details.html?id=${productId}`;
        }
      };

      let currentFilter = "all";
      let currentSort = "recent";

      // Sort wishlist
      $("wishlistSort")?.addEventListener("change", (e) => {
        currentSort = e.target.value;
        applyFiltersAndSort();
      });

      // Filter wishlist
      $("wishlistFilter")?.addEventListener("change", (e) => {
        currentFilter = e.target.value.toLowerCase();
        applyFiltersAndSort();
      });

      function applyFiltersAndSort() {
        console.log(
          "Filter:",
          currentFilter,
          "Total items:",
          allWishlistItems.length
        );

        let filtered =
          currentFilter === "all"
            ? [...allWishlistItems]
            : allWishlistItems.filter((item) => {
                const subCat = (item.product?.subCategory || "").toLowerCase();
                console.log(
                  "Product:",
                  item.product?.name,
                  "SubCat:",
                  subCat,
                  "Match:",
                  subCat.includes(currentFilter)
                );
                return (
                  subCat.includes(currentFilter) || subCat === currentFilter
                );
              });

        console.log("Filtered count:", filtered.length);

        switch (currentSort) {
          case "price-low":
            filtered.sort(
              (a, b) => (a.product?.price || 0) - (b.product?.price || 0)
            );
            break;
          case "price-high":
            filtered.sort(
              (a, b) => (b.product?.price || 0) - (a.product?.price || 0)
            );
            break;
          case "name":
            filtered.sort((a, b) =>
              (a.product?.name || "").localeCompare(b.product?.name || "")
            );
            break;
          default:
            filtered.sort(
              (a, b) => new Date(b.createdAt || 0) - new Date(a.createdAt || 0)
            );
        }

        renderWishlist(filtered);
      }

      // Clear filter
      $("clearFilterBtn")?.addEventListener("click", () => {
        $("wishlistFilter").value = "all";
        $("wishlistSort").value = "recent";
        currentFilter = "all";
        currentSort = "recent";
        applyFiltersAndSort();
      });

      // Clear all wishlist
      $("clearWishlistBtn")?.addEventListener("click", async () => {
        if (!allWishlistItems.length)
          return toast("Wishlist is empty", "error");
        showConfirmModal(
          "Clear entire wishlist? This cannot be undone.",
          async () => {
            try {
              for (const item of allWishlistItems) {
                await fetchWithRetry(
                  `${API}/wishlist/${item.product?.id || item.id}`,
                  {
                    method: "DELETE",
                    headers: { Authorization: `Bearer ${token}` },
                  }
                );
              }
              wishlistItems = [];
              allWishlistItems = [];
              renderWishlist([]);
              toast("Wishlist cleared ‚ú®", "success");
            } catch {
              toast("Failed to clear", "error");
            }
          }
        );
      });

      // === RECENTLY VIEWED ===
      const syncRecentlyViewed = async (productId) => {
        if (!buyerId) return;
        try {
          await fetch(`${API}/recently-viewed`, {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              Authorization: `Bearer ${token}`,
            },
            body: JSON.stringify({ buyerId: parseInt(buyerId), productId }),
          });
        } catch {}
      };

      const loadRecentlyViewed = async () => {
        const grid = $("recentGrid");
        grid.innerHTML =
          '<p style="text-align:center;color:#aaa;width:100%;padding:3rem 0">Loading...</p>';

        try {
          if (!buyerId) throw new Error("No buyer");
          const items = await fetchWithRetry(
            `${API}/recently-viewed/${buyerId}`,
            {
              headers: { Authorization: `Bearer ${token}` },
            }
          );
          renderRecentlyViewed(items.slice(0, 20));
        } catch {
          grid.innerHTML = `<p style="text-align:center;color:#aaa;width:100%;padding:3rem 0"><i class="fas fa-clock" style="font-size:3rem;opacity:0.3;display:block;margin-bottom:1rem"></i>Nothing viewed yet üëÄ</p>`;
        }
      };

      const renderRecentlyViewed = (items) => {
        const grid = $("recentGrid");
        grid.innerHTML = "";

        if (!items.length) {
          grid.innerHTML = `<p style="text-align:center;color:#aaa;width:100%;padding:3rem 0"><i class="fas fa-clock" style="font-size:3rem;opacity:0.3;display:block;margin-bottom:1rem"></i>Nothing viewed yet üëÄ</p>`;
          return;
        }

        items.forEach((item) => {
          const product = item.product || item;
          const card = document.createElement("div");
          card.style.cssText = `
            min-width:220px;max-width:220px;flex-shrink:0;
            background:rgba(255,255,255,0.08);border-radius:12px;overflow:hidden;
            transition:transform 0.3s,box-shadow 0.3s;cursor:pointer;
            box-shadow:0 4px 15px rgba(0,0,0,0.2);
          `;
          card.onmouseenter = () => {
            card.style.transform = "translateY(-8px)";
            card.style.boxShadow = "0 8px 25px rgba(0,0,0,0.4)";
          };
          card.onmouseleave = () => {
            card.style.transform = "";
            card.style.boxShadow = "0 4px 15px rgba(0,0,0,0.2)";
          };

          const imgSrc = product.images?.[0]
            ? `${BACKEND_URL}${product.images[0]}`
            : "https://via.placeholder.com/220x160/1a1a1a/666?text=No+Image";

          card.innerHTML = `
            <div style="position:relative">
              <img src="${imgSrc}" alt="${
            product.name
          }" loading="lazy" style="width:100%;height:160px;object-fit:cover" onerror="this.src='https://via.placeholder.com/220x160/1a1a1a/666?text=No+Image'" />
              <button onclick="event.stopPropagation();removeFromRecent(${
                product.id
              })" style="position:absolute;top:8px;right:8px;background:rgba(0,0,0,0.8);border:none;color:#fff;width:28px;height:28px;border-radius:50%;cursor:pointer;display:flex;align-items:center;justify-content:center;font-size:0.8rem"><i class="fas fa-times"></i></button>
            </div>
            <div style="padding:12px">
              <strong style="font-size:0.95rem;display:block;margin-bottom:6px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;color:#fff">${
                product.name
              }</strong>
              <span style="color:var(--green-light);font-size:1.1rem;font-weight:700;display:block;margin-bottom:8px">‚Çµ${Number(
                product.price
              ).toFixed(2)}</span>
              <button onclick="viewProductDetails(${
                product.id
              })" style="width:100%;padding:8px;background:var(--green-light);color:#000;border:none;border-radius:8px;font-weight:600;cursor:pointer;font-size:0.85rem">View Again</button>
            </div>
          `;
          grid.appendChild(card);
        });
      };

      window.viewProductDetails = (id) => {
        syncRecentlyViewed(id);
        location.href = `../Dex-product-details.html?id=${id}`;
      };

      window.removeFromRecent = async (productId) => {
        if (!buyerId) return;
        try {
          await fetchWithRetry(`${API}/recently-viewed`, {
            method: "DELETE",
            headers: {
              "Content-Type": "application/json",
              Authorization: `Bearer ${token}`,
            },
            body: JSON.stringify({ buyerId: parseInt(buyerId), productId }),
          });
          toast("Removed from history ‚ú®", "success");
          loadRecentlyViewed();
        } catch {
          toast("Failed to remove", "error");
        }
      };

      // === MOBILE MENU & OVERLAY ===
      $("hamburger").addEventListener("click", (e) => {
        e.stopPropagation();
        const open = !mobileMenu.classList.contains("open");
        mobileMenu.classList.toggle("open", open);
        notifSidebar.classList.remove("open");
        overlay.classList.toggle("active", open);
      });

      document.addEventListener("click", (e) => {
        if (
          mobileMenu.classList.contains("open") &&
          !mobileMenu.contains(e.target)
        ) {
          mobileMenu.classList.remove("open");
          overlay.classList.remove("active");
        }
        if (
          notifSidebar.classList.contains("open") &&
          !notifSidebar.contains(e.target)
        ) {
          notifSidebar.classList.remove("open");
          overlay.classList.remove("active");
        }
      });

      document.addEventListener("keydown", (e) => {
        if (e.key === "Escape") {
          mobileMenu.classList.remove("open");
          notifSidebar.classList.remove("open");
          overlay.classList.remove("active");
        }
      });

      const logout = () => {
        localStorage.clear();
        sessionStorage.clear();
        location.replace("../REGISTRY_PAGES/Sign_in.html");
      };

      $("logoutBtn").onclick = logout;

      // Password visibility toggle
      window.togglePasswordVisibility = (inputId) => {
        const input = document.getElementById(inputId);
        const btn = input.nextElementSibling;
        const icon = btn.querySelector("i");
        if (input.type === "password") {
          input.type = "text";
          icon.className = "fas fa-eye-slash";
        } else {
          input.type = "password";
          icon.className = "fas fa-eye";
        }
      };

      // === HOSTEL BOOKINGS ===
      const loadBookings = async () => {
        const grid = $("bookingsGrid");
        grid.innerHTML =
          '<p style="grid-column:1/-1;text-align:center;color:#aaa">Loading...</p>';
        try {
          const bookings = await fetchWithRetry(
            `${API}/products/hostel/my-bookings`,
            {
              headers: { Authorization: `Bearer ${token}` },
            }
          );
          renderBookings(bookings);
        } catch {
          grid.innerHTML =
            '<p style="grid-column:1/-1;text-align:center;color:#aaa">Failed to load.</p>';
        }
      };

      const renderBookings = (bookings) => {
        const grid = $("bookingsGrid");
        if (!bookings.length) {
          grid.innerHTML =
            '<p style="grid-column:1/-1;text-align:center;padding:3rem;color:#aaa">No bookings yet üè®</p>';
          return;
        }
        grid.innerHTML = bookings
          .map((b) => {
            const statusColors = {
              pending: "#f39c12",
              accepted: "#27ae60",
              rejected: "#e74c3c",
            };
            const statusColor = statusColors[b.bookingStatus] || "#999";
            return `
            <div class="order-card">
              <img src="${
                b.product?.images?.[0]
                  ? BACKEND_URL + b.product.images[0]
                  : "https://via.placeholder.com/300"
              }" alt="${b.product?.name || "Hostel"}" />
              <div class="order-details">
                <strong>${b.product?.name || "Hostel Room"}</strong>
                <span>Seller: ${b.product?.seller?.name || "Unknown"}</span>
                <span>Price: ‚Çµ${b.product?.price || 0}/month</span>
                <span style="background:${statusColor};color:#fff;padding:4px 10px;border-radius:12px;font-size:0.85rem;font-weight:600;align-self:flex-start;margin-top:0.5rem">
                  ${b.bookingStatus?.toUpperCase() || "PENDING"}
                </span>
                ${
                  b.bookingNotes
                    ? `<span style="color:#ccc;font-size:0.9rem;margin-top:0.5rem">Notes: ${b.bookingNotes}</span>`
                    : ""
                }
              </div>
              <div class="order-actions">
                ${
                  b.bookingStatus === "pending"
                    ? `<button class="btn btn-cancel" onclick="cancelBooking(${b.id})">Cancel</button>`
                    : ""
                }
                ${
                  b.bookingStatus === "accepted"
                    ? `<button class="btn btn-track" onclick="contactSeller('${
                        b.product?.seller?.phone || ""
                      }')">Contact Seller</button>`
                    : ""
                }
              </div>
            </div>
          `;
          })
          .join("");
      };

      window.cancelBooking = async (bookingId) => {
        showConfirmModal("Cancel this booking?", async () => {
          try {
            await fetchWithRetry(
              `${API}/products/hostel/my-bookings/${bookingId}`,
              {
                method: "DELETE",
                headers: { Authorization: `Bearer ${token}` },
              }
            );
            toast("Booking cancelled ‚ùå", "success");
            loadBookings();
          } catch (err) {
            console.error("Cancel booking error:", err);
            toast("Failed to cancel", "error");
          }
        });
      };

      window.contactSeller = (phone) => {
        if (!phone) return toast("No contact info", "error");
        const cleanPhone = String(phone)
          .replace(/\D/g, "")
          .replace(/^0/, "233");
        if (!/^\d{10,15}$/.test(cleanPhone)) {
          console.error("Invalid phone format:", phone);
          return toast("Invalid phone number", "error");
        }
        window.open(
          `https://wa.me/${cleanPhone}`,
          "_blank",
          "noopener,noreferrer"
        );
      };

      // === FOLLOWED SHOPS ===
      let allFollowedShops = [];
      let filteredShops = [];

      const loadFollowedShops = async () => {
        const grid = $("followedGrid");
        grid.innerHTML =
          '<p style="grid-column:1/-1;text-align:center;color:#aaa">Loading...</p>';
        try {
          const shops = await fetchWithRetry(`${API}/seller/following`, {
            headers: { Authorization: `Bearer ${token}` },
          });
          console.log("Followed shops data:", shops);
          allFollowedShops = shops;
          filteredShops = shops;
          await renderFollowedShops(shops);
        } catch {
          grid.innerHTML =
            '<p style="grid-column:1/-1;text-align:center;color:#aaa">Failed to load.</p>';
        }
      };

      const renderFollowedShops = async (shops) => {
        const grid = $("followedGrid");
        const count = $("followedCount");
        if (count) count.textContent = `(${shops.length})`;

        if (!shops.length) {
          grid.innerHTML =
            '<p style="grid-column:1/-1;text-align:center;padding:3rem;color:#aaa"><i class="fas fa-store" style="font-size:3rem;opacity:0.3;display:block;margin-bottom:1rem"></i>No followed shops yet üè™</p>';
          return;
        }

        const shopCards = [];
        for (const { seller } of shops) {
          let shopSettings = null;
          try {
            const settingsRes = await fetch(
              `${API}/shop/settings/public/${seller.id}`
            );
            if (settingsRes.ok) {
              shopSettings = await settingsRes.json();
            }
          } catch (e) {}

          shopCards.push(renderShopCard(seller, shopSettings));
        }

        grid.innerHTML = shopCards.join("");
      };

      const renderShopCard = (seller, shopSettings) => {
        const categoryIcons = {
          electronics: "üì±",
          fashion: "üëó",
          hostels: "üè®",
          hostel: "üè®",
        };
        const cat = (seller.productCategory || "").toLowerCase();
        const icon = categoryIcons[cat] || "üè™";
        const productCount = seller.products?.length || 0;

        const settings = shopSettings || seller.shopSettings;
        const primaryColor = settings?.primaryColor || "#6ecf45";
        const accentColor = settings?.accentColor || "#2b7a0b";
        const tagline = settings?.tagline || "";
        const bannerConfig = settings?.bannerConfig || null;
        const shopLogo = settings?.shopLogo
          ? BACKEND_URL + settings.shopLogo
          : null;
        const logoType = settings?.logoType || "text";
        const logoText =
          settings?.logoText || seller.name.charAt(0).toUpperCase();
        const logoIcon = settings?.logoIcon || icon;
        const logoTextColor = settings?.logoTextColor || "#fff";
        const logoIconColor = settings?.logoIconColor || "#fff";
        const logoBackgroundColor =
          settings?.logoBackgroundColor || primaryColor;

        let imgSrc;
        if (shopLogo) {
          imgSrc = shopLogo;
        } else if (logoType === "text") {
          imgSrc = `data:image/svg+xml,${encodeURIComponent(
            `<svg width="120" height="120" xmlns="http://www.w3.org/2000/svg"><rect width="120" height="120" fill="${logoBackgroundColor}"/><text x="50%" y="50%" dominant-baseline="middle" text-anchor="middle" font-size="48" font-weight="bold" fill="${logoTextColor}">${logoText}</text></svg>`
          )}`;
        } else if (logoType === "icon") {
          imgSrc = `data:image/svg+xml,${encodeURIComponent(
            `<svg width="120" height="120" xmlns="http://www.w3.org/2000/svg"><rect width="120" height="120" fill="${logoBackgroundColor}"/><text x="50%" y="50%" dominant-baseline="middle" text-anchor="middle" font-size="48">${logoIcon}</text></svg>`
          )}`;
        } else if (logoType === "combo") {
          imgSrc = `data:image/svg+xml,${encodeURIComponent(
            `<svg width="120" height="120" xmlns="http://www.w3.org/2000/svg"><rect width="120" height="120" fill="${logoBackgroundColor}"/><text x="50%" y="40%" dominant-baseline="middle" text-anchor="middle" font-size="32">${logoIcon}</text><text x="50%" y="70%" dominant-baseline="middle" text-anchor="middle" font-size="20" font-weight="bold" fill="${logoTextColor}">${logoText}</text></svg>`
          )}`;
        } else if (seller.profilePic) {
          imgSrc = BACKEND_URL + seller.profilePic;
        } else {
          imgSrc = `data:image/svg+xml,${encodeURIComponent(
            `<svg width="120" height="120" xmlns="http://www.w3.org/2000/svg"><rect width="120" height="120" fill="${logoBackgroundColor}"/><text x="50%" y="50%" dominant-baseline="middle" text-anchor="middle" font-size="48" font-weight="bold" fill="${logoTextColor}">${logoText}</text></svg>`
          )}`;
        }

        let bannerStyle = "";
        if (bannerConfig?.type === "color") {
          bannerStyle = `background:${bannerConfig.bgColor || primaryColor}`;
        } else if (bannerConfig?.type === "gradient") {
          bannerStyle = `background:linear-gradient(${
            bannerConfig.gradientDirection || "135deg"
          },${bannerConfig.color1 || primaryColor},${
            bannerConfig.color2 || accentColor
          })`;
        } else if (bannerConfig?.type === "pattern") {
          const base = bannerConfig.patternBaseColor || primaryColor;
          bannerStyle = `background:${base};background-image:radial-gradient(circle,rgba(255,255,255,0.2) 1px,transparent 1px);background-size:20px 20px`;
        } else if (bannerConfig?.image) {
          bannerStyle = `background:url('${BACKEND_URL}${bannerConfig.image}') center/cover`;
        } else {
          bannerStyle = `background:linear-gradient(135deg,${primaryColor},${accentColor})`;
        }

        return `
          <div style="position:relative;display:flex;flex-direction:column;align-items:center;gap:0.5rem">
            <div style="position:relative;cursor:pointer;" onclick="location.href='../sellerShop.html?sellerId=${
              seller.id
            }'">
              <div style="width:120px;height:120px;border-radius:50%;overflow:hidden;border:4px solid ${primaryColor};box-shadow:0 8px 25px rgba(0,0,0,0.3);transition:transform 0.3s,box-shadow 0.3s;background:${logoBackgroundColor}" 
                   onmouseenter="this.style.transform='scale(1.1)';this.style.boxShadow='0 12px 35px rgba(110,207,69,0.4)';this.nextElementSibling.style.opacity='1';this.nextElementSibling.style.visibility='visible'"
                   onmouseleave="this.style.transform='';this.style.boxShadow='0 8px 25px rgba(0,0,0,0.3)';this.nextElementSibling.style.opacity='0';this.nextElementSibling.style.visibility='hidden'">
                <img src="${imgSrc}" alt="${
          seller.name
        }" style="width:100%;height:100%;object-fit:cover" onerror="this.src='data:image/svg+xml,${encodeURIComponent(
          `<svg width='120' height='120' xmlns='http://www.w3.org/2000/svg'><rect width='120' height='120' fill='${accentColor}'/><text x='50%' y='50%' dominant-baseline='middle' text-anchor='middle' font-size='48' font-weight='bold' fill='#fff'>${seller.name.charAt(
            0
          )}</text></svg>`
        )}'"/>
              </div>
              <div style="position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);background:rgba(0,0,0,0.95);backdrop-filter:blur(20px);border-radius:16px;overflow:hidden;min-width:280px;max-width:320px;box-shadow:0 20px 60px rgba(0,0,0,0.5);opacity:0;visibility:hidden;transition:opacity 0.3s,visibility 0.3s;z-index:10;border:2px solid ${primaryColor}" 
                   onmouseenter="this.style.opacity='1';this.style.visibility='visible'"
                   onmouseleave="this.style.opacity='0';this.style.visibility='hidden'">
                ${
                  bannerConfig?.text
                    ? `<div style="${bannerStyle};padding:20px 12px;text-align:center"><strong style="color:${
                        bannerConfig.textColor || "#fff"
                      };font-size:0.9rem">${bannerConfig.text}</strong></div>`
                    : `<div style="${bannerStyle};height:60px"></div>`
                }
                <div style="padding:1.5rem;text-align:center">
                  <div style="font-size:2rem;margin-bottom:0.5rem">${icon}</div>
                  <strong style="font-size:1.1rem;display:block;margin-bottom:0.5rem;color:#fff">${
                    seller.name
                  }</strong>
                  ${
                    tagline
                      ? `<p style="font-size:0.8rem;color:#aaa;margin:0 0 0.5rem 0">${tagline}</p>`
                      : ""
                  }
                  <span style="background:rgba(${parseInt(
                    primaryColor.slice(1, 3),
                    16
                  )},${parseInt(primaryColor.slice(3, 5), 16)},${parseInt(
          primaryColor.slice(5, 7),
          16
        )},0.2);color:${primaryColor};padding:4px 12px;border-radius:20px;font-size:0.85rem;display:inline-block;margin-bottom:1rem">${
          seller.productCategory || "Shop"
        }</span>
                  <div style="color:#aaa;font-size:0.9rem;margin-bottom:1rem">
                    <i class="fas fa-box"></i> ${productCount} products
                  </div>
                  <div style="display:flex;gap:0.5rem">
                    <button onclick="event.stopPropagation();location.href='../sellerShop.html?sellerId=${
                      seller.id
                    }'" style="flex:1;padding:8px 12px;background:${primaryColor};color:#000;border:none;border-radius:8px;font-weight:600;cursor:pointer;font-size:0.85rem">
                      <i class="fas fa-store"></i> Visit
                    </button>
                    <button onclick="event.stopPropagation();unfollowShop(${
                      seller.id
                    })" style="flex:1;padding:8px 12px;background:#e74c3c;color:#fff;border:none;border-radius:8px;font-weight:600;cursor:pointer;font-size:0.85rem">
                      <i class="fas fa-times"></i>
                    </button>
                  </div>
                </div>
              </div>
            </div>
            <span style="font-size:0.9rem;color:#fff;font-weight:600;text-align:center;max-width:120px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">${
              seller.name
            }</span>
          </div>
        `;
      };

      window.unfollowShop = async (sellerId) => {
        showConfirmModal("Unfollow this shop?", async () => {
          try {
            await fetchWithRetry(`${API}/seller/follow/${sellerId}`, {
              method: "DELETE",
              headers: { Authorization: `Bearer ${token}` },
            });
            allFollowedShops = allFollowedShops.filter(
              (s) => s.seller.id !== sellerId
            );
            applyShopFilters();
            toast("Unfollowed üëã", "success");
          } catch (err) {
            console.error("Unfollow error:", err);
            toast("Failed to unfollow", "error");
          }
        });
      };

      // Shop search
      $("shopSearch")?.addEventListener(
        "input",
        debounce((e) => {
          applyShopFilters();
        }, 300)
      );

      // Shop filter
      $("shopFilter")?.addEventListener("change", () => {
        applyShopFilters();
      });

      async function applyShopFilters() {
        const searchTerm = ($("shopSearch")?.value || "").toLowerCase();
        const filterCat = ($("shopFilter")?.value || "all").toLowerCase();

        let filtered = allFollowedShops.filter(({ seller }) => {
          const nameMatch = seller.name.toLowerCase().includes(searchTerm);
          const catMatch =
            filterCat === "all" ||
            seller.productCategory?.toLowerCase().includes(filterCat);
          return nameMatch && catMatch;
        });

        await renderFollowedShops(filtered);
      }

      // Unfollow all
      $("unfollowAllBtn")?.addEventListener("click", async () => {
        if (!allFollowedShops.length)
          return toast("No shops to unfollow", "error");
        showConfirmModal(
          "Unfollow all shops? This cannot be undone.",
          async () => {
            try {
              for (const { seller } of allFollowedShops) {
                await fetchWithRetry(`${API}/seller/follow/${seller.id}`, {
                  method: "DELETE",
                  headers: { Authorization: `Bearer ${token}` },
                });
              }
              allFollowedShops = [];
              filteredShops = [];
              await renderFollowedShops([]);
              toast("Unfollowed all shops ‚ú®", "success");
            } catch {
              toast("Failed to unfollow all", "error");
            }
          }
        );
      });

      // === SETTINGS ===
      const loadSettings = async () => {
        // Fetch fresh profile data to get verification status
        try {
          const profile = await fetchWithRetry(`${API}/buyers/profile`, {
            headers: { Authorization: `Bearer ${token}` }
          });
          
          // Update user object with fresh verification data
          user.phoneVerified = profile.phoneVerified;
          user.isVerified = profile.isVerified;
          user.studentVerified = profile.studentVerified;
          
          // Update localStorage with fresh data
          localStorage.setItem("currentUser", JSON.stringify(user));
          sessionStorage.setItem("currentUser", JSON.stringify(user));
        } catch (err) {
          console.error('Failed to fetch profile:', err);
        }
        
        // Update verification button states
        if (user.phoneVerified) {
          $("verifyPhoneBtn").textContent = "‚úÖ Verified";
          $("verifyPhoneBtn").disabled = true;
        }
        if (user.isVerified) {
          $("verifyEmailBtn").textContent = "‚úÖ Verified";
          $("verifyEmailBtn").disabled = true;
        }
        if (user.studentVerified) {
          $("verifyStudentBtn").textContent = "‚úÖ Verified";
          $("verifyStudentBtn").disabled = true;
        }
        
        // Load notification preferences
        const prefs = JSON.parse(
          localStorage.getItem("notifPrefs") ||
            '{"orders":true,"safety":true,"verification":true,"promotions":false}'
        );
        $("notifOrders").checked = prefs.orders;
        $("notifSafety").checked = prefs.safety;
        $("notifVerification").checked = prefs.verification;
        $("notifPromotions").checked = prefs.promotions;

        // Load privacy settings
        try {
          const privacy = await fetchWithRetry(`${API}/buyers/privacy-settings`, {
            headers: { Authorization: `Bearer ${token}` }
          });
          $("profileVisibility").value = privacy.profileVisibility || 'public';
          $("contactPrefs").value = privacy.contactPrefs || 'everyone';
          $("showRealName").checked = privacy.showRealName || false;
        } catch {}

        // Load safety settings
        try {
          const safety = await fetchWithRetry(`${API}/buyers/safety-settings`, {
            headers: { Authorization: `Bearer ${token}` }
          });
          $("meetingLocations").value = safety.meetingLocations || '';
          $("emergencyContact").value = safety.emergencyContact || '';
        } catch {}

        // Load trust settings
        try {
          const trust = await fetchWithRetry(`${API}/buyers/trust-settings`, {
            headers: { Authorization: `Bearer ${token}` }
          });
          $("showTrustScore").checked = trust.showTrustScore !== false;
        } catch {}
      };

      $("changePasswordBtn").onclick = async () => {
        const current = $("currentPassword").value;
        const newPass = $("newPassword").value;
        const confirm = $("confirmPassword").value;
        if (!current || !newPass || !confirm)
          return toast("Fill all fields", "error");
        if (newPass !== confirm) return toast("Passwords don't match", "error");
        if (newPass.length < 6)
          return toast("Password too short (min 6)", "error");
        try {
          await fetchWithRetry(`${API}/buyers/change-password`, {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              Authorization: `Bearer ${token}`,
            },
            body: JSON.stringify({
              currentPassword: current,
              newPassword: newPass,
            }),
          });
          toast("Password updated ‚úÖ", "success");
          $("currentPassword").value =
            $("newPassword").value =
            $("confirmPassword").value =
              "";
        } catch {
          toast("Update failed ‚ùå", "error");
        }
      };

      // === VERIFICATION FUNCTIONS ===
      $("verifyPhoneBtn").onclick = () => {
        if (user.phoneVerified) {
          toast("Phone already verified ‚úÖ", "success");
          return;
        }
        toast("Phone verification coming soon! Use email verification for now üìß", "info");
      };

      $("verifyEmailBtn").onclick = async () => {
        if (user.isVerified) {
          toast("Email already verified ‚úÖ", "success");
          return;
        }
        
        try {
          await fetchWithRetry(`${API}/buyers/resend-verification`, {
            method: "POST",
            headers: { "Content-Type": "application/json", Authorization: `Bearer ${token}` },
            body: JSON.stringify({ email: user.email })
          });
          toast("Verification email sent ‚úâÔ∏è", "success");
        } catch {
          toast("Failed to send email", "error");
        }
      };

      $("verifyStudentBtn").onclick = () => {
        if (user.studentVerified) {
          toast("Student ID already verified ‚úÖ", "success");
          return;
        }
        
        const input = document.createElement('input');
        input.type = 'file';
        input.accept = 'image/*,.pdf';
        input.onchange = async (e) => {
          const file = e.target.files[0];
          if (!file) return;
          
          const formData = new FormData();
          formData.append('studentID', file);
          
          try {
            await fetch(`${API}/buyers/submit-student-id`, {
              method: "POST",
              headers: { Authorization: `Bearer ${token}` },
              body: formData
            });
            toast("Student ID submitted for review! We'll notify you within 24 hours üéì", "success");
            $("verifyStudentBtn").textContent = "‚è≥ Under Review";
            $("verifyStudentBtn").disabled = true;
          } catch {
            toast("Upload failed. Try again.", "error");
          }
        };
        input.click();
      };

      // === PRIVACY SETTINGS ===
      $("savePrivacyBtn").onclick = async () => {
        const settings = {
          profileVisibility: $("profileVisibility").value,
          contactPrefs: $("contactPrefs").value,
          showRealName: $("showRealName").checked
        };
        try {
          await fetchWithRetry(`${API}/buyers/privacy-settings`, {
            method: "POST",
            headers: { "Content-Type": "application/json", Authorization: `Bearer ${token}` },
            body: JSON.stringify(settings)
          });
          toast("Privacy settings saved üîí", "success");
        } catch {
          toast("Failed to save settings", "error");
        }
      };

      // === SAFETY SETTINGS ===
      $("saveSafetyBtn").onclick = async () => {
        const settings = {
          meetingLocations: $("meetingLocations").value,
          emergencyContact: $("emergencyContact").value
        };
        try {
          await fetchWithRetry(`${API}/buyers/safety-settings`, {
            method: "POST",
            headers: { "Content-Type": "application/json", Authorization: `Bearer ${token}` },
            body: JSON.stringify(settings)
          });
          toast("Safety settings saved üõ°Ô∏è", "success");
        } catch {
          toast("Failed to save settings", "error");
        }
      };

      $("viewBlockedBtn").onclick = () => {
        showAlertModal("Blocked Users:\n\nNo blocked users yet.\n\nYou can block users from their profile or chat.");
      };

      $("reportUserBtn").onclick = () => {
        const modal = document.createElement('div');
        modal.style.cssText = 'position:fixed;inset:0;background:rgba(0,0,0,0.7);display:flex;align-items:center;justify-content:center;z-index:10001;';
        modal.innerHTML = `
          <div style="background:#1a1a1a;padding:2rem;border-radius:16px;max-width:400px;box-shadow:0 20px 60px rgba(0,0,0,0.5);">
            <h3 style="color:#fff;margin-bottom:1rem;">Report User</h3>
            <input type="text" id="reportUserId" placeholder="User ID or username" style="width:100%;padding:12px;margin-bottom:1rem;border-radius:8px;background:rgba(255,255,255,0.1);color:#fff;border:1px solid rgba(255,255,255,0.2);" />
            <textarea id="reportReason" placeholder="Reason for reporting..." style="width:100%;min-height:80px;padding:12px;margin-bottom:1rem;border-radius:8px;background:rgba(255,255,255,0.1);color:#fff;border:1px solid rgba(255,255,255,0.2);font-family:inherit;resize:vertical;"></textarea>
            <div style="display:flex;gap:1rem;justify-content:flex-end;">
              <button onclick="this.closest('div').parentElement.remove()" style="padding:0.75rem 1.5rem;background:rgba(255,255,255,0.1);color:#fff;border:none;border-radius:8px;cursor:pointer;">Cancel</button>
              <button onclick="submitReport()" style="padding:0.75rem 1.5rem;background:#e74c3c;color:#fff;border:none;border-radius:8px;cursor:pointer;font-weight:600;">Report</button>
            </div>
          </div>
        `;
        document.body.appendChild(modal);
        window.submitReport = async () => {
          const userId = modal.querySelector('#reportUserId').value;
          const reason = modal.querySelector('#reportReason').value;
          if (!userId || !reason) return toast('Fill all fields', 'error');
          try {
            await fetchWithRetry(`${API}/buyers/report-user`, {
              method: "POST",
              headers: { "Content-Type": "application/json", Authorization: `Bearer ${token}` },
              body: JSON.stringify({ userId, reason })
            });
            toast('Report submitted üö®', 'success');
            modal.remove();
          } catch {
            toast('Failed to submit report', 'error');
          }
        };
      };

      // === TRUST SETTINGS ===
      $("saveTrustBtn").onclick = async () => {
        const settings = {
          showTrustScore: $("showTrustScore").checked
        };
        try {
          await fetchWithRetry(`${API}/buyers/trust-settings`, {
            method: "POST",
            headers: { "Content-Type": "application/json", Authorization: `Bearer ${token}` },
            body: JSON.stringify(settings)
          });
          toast("Trust settings saved ‚≠ê", "success");
        } catch {
          toast("Failed to save settings", "error");
        }
      };

      $("viewBadgesBtn").onclick = () => {
        showAlertModal("Your Badges:\n\nüéì Student Verified\nüì± Phone Verified\n‚úâÔ∏è Email Verified\n‚≠ê Trusted Buyer\n\nComplete more verifications to earn badges!");
      };

      $("interactionHistoryBtn").onclick = () => {
        showAlertModal("Interaction History:\n\n‚úÖ 15 successful meetups\n‚≠ê 4.8 average rating\nü§ù 12 positive reviews\nüìÖ Member since: Jan 2024\n\nKeep building trust!");
      };

      // === NOTIFICATION SETTINGS ===
      $("saveNotifBtn").onclick = () => {
        const prefs = {
          orders: $("notifOrders").checked,
          safety: $("notifSafety").checked,
          verification: $("notifVerification").checked,
          promotions: $("notifPromotions").checked
        };
        localStorage.setItem("notifPrefs", JSON.stringify(prefs));
        toast("Preferences saved ‚úÖ", "success");
      };

      $("deleteAccountBtn").onclick = async () => {
        showConfirmModal(
          "‚ö†Ô∏è Delete your account? This cannot be undone!",
          () => {
            showConfirmModal(
              "Are you absolutely sure? All your data will be lost.",
              async () => {
                try {
                  await fetchWithRetry(`${API}/buyers/delete-account`, {
                    method: "DELETE",
                    headers: { Authorization: `Bearer ${token}` },
                  });
                  toast("Account deleted", "success");
                  setTimeout(logout, 1500);
                } catch (err) {
                  console.error("Delete account error:", err);
                  toast("Delete failed", "error");
                }
              }
            );
          }
        );
      };

      // === HELP ===
      const loadHelp = () => {};

      $("submitSupportBtn").onclick = async () => {
        const subject = $("supportSubject").value.trim();
        const message = $("supportMessage").value.trim();
        if (!subject || !message) return toast("Fill all fields", "error");
        try {
          await fetchWithRetry(`${API}/buyers/support-ticket`, {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              Authorization: `Bearer ${token}`,
            },
            body: JSON.stringify({ subject, message }),
          });
          toast("Ticket submitted ‚úÖ", "success");
          $("supportSubject").value = $("supportMessage").value = "";
        } catch {
          toast("Submit failed", "error");
        }
      };

      // === ORDER TAB SWITCHING ===
      $("buyerActiveTab")?.addEventListener("click", () => {
        $("activeOrdersGrid").style.display = "grid";
        $("deliveredSection").style.display = "none";
        $("cancelledSection").style.display = "none";
      });

      $("buyerDeliveredTab")?.addEventListener("click", () => {
        $("activeOrdersGrid").style.display = "none";
        $("deliveredSection").style.display = "block";
        $("cancelledSection").style.display = "none";
      });

      $("buyerRejectedTab")?.addEventListener("click", () => {
        $("activeOrdersGrid").style.display = "none";
        $("deliveredSection").style.display = "none";
        $("cancelledSection").style.display = "block";
      });

      // === CLEAR ALL BUTTONS ===
      $("clearDeliveredBtn")?.addEventListener("click", async () => {
        showConfirmModal(
          "Clear all delivered orders? This will permanently delete them.",
          async () => {
            try {
              await fetchWithRetry(`${API}/orders/clear/delivered`, {
                method: "DELETE",
                headers: { Authorization: `Bearer ${token}` },
              });
              $("deliveredOrdersGrid").innerHTML =
                '<p style="grid-column:1/-1;text-align:center;padding:3rem;color:#aaa"><i class="fas fa-truck" style="font-size:3rem;opacity:0.3;display:block;margin-bottom:1rem"></i>No delivered orders yet üì¶</p>';
              $("buyerDeliveredBadge").style.display = "none";
              toast("Delivered orders cleared ‚ú®", "success");
            } catch (err) {
              console.error("Clear delivered error:", err);
              toast("Failed to clear orders ‚ùå", "error");
            }
          }
        );
      });

      $("clearCancelledBtn")?.addEventListener("click", async () => {
        showConfirmModal(
          "Clear all cancelled/rejected orders? This will permanently delete them.",
          async () => {
            try {
              await fetchWithRetry(`${API}/orders/clear/rejected`, {
                method: "DELETE",
                headers: { Authorization: `Bearer ${token}` },
              });
              $("cancelledOrdersGrid").innerHTML =
                '<p style="grid-column:1/-1;text-align:center;padding:3rem;color:#aaa"><i class="fas fa-times-circle" style="font-size:3rem;opacity:0.3;display:block;margin-bottom:1rem"></i>No cancelled/rejected orders üö´</p>';
              $("buyerRejectedBadge").style.display = "none";
              toast("Cancelled orders cleared ‚ú®", "success");
            } catch (err) {
              console.error("Clear cancelled error:", err);
              toast("Failed to clear orders ‚ùå", "error");
            }
          }
        );
      });

      // === WEBSOCKET FOR ORDER UPDATES ===
      let orderWs = null;
      const connectOrderWebSocket = () => {
        try {
          orderWs = new WebSocket(`ws://localhost:5000?userId=${buyerId}`);
          orderWs.onopen = () => console.log("‚úÖ Order WebSocket connected");
          orderWs.onmessage = (e) => {
            const data = JSON.parse(e.data);
            if (data.type === "order") {
              console.log("üì¶ Order update received");
              fetchOrders();
            }
          };
          orderWs.onerror = () =>
            console.log("Order WebSocket error, using polling");
          orderWs.onclose = () => setTimeout(connectOrderWebSocket, 5000);
        } catch {}
      };
      connectOrderWebSocket();

      // Polling fallback
      let lastOrderCount = 0;
      setInterval(async () => {
        try {
          const orders = await fetchWithRetry(`${API}/orders`, {
            headers: { Authorization: `Bearer ${token}` },
          });
          if (lastOrderCount > 0 && orders.length !== lastOrderCount)
            fetchOrders();
          lastOrderCount = orders.length;
        } catch {}
      }, 10000);

      // WhatsApp float button
      $("whatsappFloatBtn")?.addEventListener("click", () => {
        showAlertModal(
          "We reply in <5 mins!\nWhatsApp: +233 55 123 4567\nhello@dex.com ‚ù§Ô∏è"
        );
      });

      // Clear all recently viewed
      $("clearRecentBtn")?.addEventListener("click", async () => {
        showConfirmModal("Clear all recently viewed products?", async () => {
          if (!buyerId) return;
          try {
            const items = await fetchWithRetry(
              `${API}/recently-viewed/${buyerId}`,
              {
                headers: { Authorization: `Bearer ${token}` },
              }
            );
            for (const item of items) {
              await fetchWithRetry(`${API}/recently-viewed`, {
                method: "DELETE",
                headers: {
                  "Content-Type": "application/json",
                  Authorization: `Bearer ${token}`,
                },
                body: JSON.stringify({
                  buyerId: parseInt(buyerId),
                  productId: item.product.id,
                }),
              });
            }
            $(
              "recentGrid"
            ).innerHTML = `<p style="text-align:center;color:#aaa;width:100%;padding:3rem 0"><i class="fas fa-clock" style="font-size:3rem;opacity:0.3;display:block;margin-bottom:1rem"></i>Nothing viewed yet üëÄ</p>`;
            toast("History cleared ‚ú®", "success");
          } catch {
            toast("Failed to clear", "error");
          }
        });
      });

      // === INIT ===
      document.addEventListener("DOMContentLoaded", () => {
        fetchOrders();
        fetchWishlist();
        loadRecentlyViewed();

        const chatScript = document.createElement("script");
        chatScript.src = "assets/js/order-chat.js";
        chatScript.onload = () => {
          if (window.OrderChat && buyerId) {
            window.OrderChat.init(buyerId);
          }
        };
        document.head.appendChild(chatScript);
      });
    </script>
  </body>
</html>
